<head>
  <meta charset="UTF-8">
</head>

<div id="leanpub-main" class="markuaspec">
  <h1 id="preface">Preface</h1>
  <p>I have been working in the field of artificial intelligence since 1982 and without a doubt Large Language Models (LLMs) like GPT-3 and infrastructure projects like LangChain are the largest technology breakthroughs that I have lived through. This book will use the <a href="https://github.com/hwchase17/langchain">LangChain</a> and <a href="https://github.com/jerryjliu/gpt_index">GPT Index (LlamaIndex)</a> projects along with the OpenAI GPT-3 and ChatGPT APIs to solve a series of interesting problems.</p>
  <p>Harrison Chase started the LangChain project in October 2022 and as I write this book in February 2023 the GitHub repository for LangChain <a href="https://github.com/hwchase17/langchain">https://github.com/hwchase17/langchain</a> has 171 contributors. Jerry Liu started the GPT Index project (recently renamed to LlamaIndex) at the end of 2022 and the GitHub Repository for LlamaIndex <a href="https://github.com/jerryjliu/gpt_index">https://github.com/jerryjliu/gpt_index</a> currently has 54 contributors.</p>
  <p>The GitHub repository for examples in this book is <a href="https://github.com/mark-watson/langchain-book-examples.git">https://github.com/mark-watson/langchain-book-examples.git</a>. Please note that I usually update the code in the examples repository fairly frequently for library version updates, etc.</p>
  <p>While the documentation and examples online for LangChain and LlamaIndex are excellent, I am still motivated to write this book to solve interesting problems that I like to work on involving information retrieval, natural language processing (NLP), dialog agents, and the semantic web/linked data fields. I hope that you, dear reader, will be delighted with these examples and that at least some of them will inspire your future projects.</p>
  <h2 id="about-the-author">About the Author</h2>
  <p>I have written over 20 books, I have over 50 US patents, and I have worked at interesting companies like Google, Capital One, SAIC, Mind AI, and others. You can find links for reading most of my recent books free on my web site <a href="https://markwatson.com">https://markwatson.com</a>. If I had to summarize my career the short take would be that I have had a lot of fun and enjoyed my work. I hope that what you learn here will be both enjoyable and help you in your work.</p>
  <p>If you would like to support my work please consider purchasing my books on <a href="https://leanpub.com/u/markwatson">Leanpub</a> and star my git repositories that you find useful on <a href="https://github.com/mark-watson?tab=repositories&amp;q=&amp;type=public">GitHub</a>. You can also interact with me on social media on <a href="https://mastodon.social/@mark_watson">Mastodon</a> and <a href="https://twitter.com/mark_l_watson">Twitter</a>. I am also available as a consultant: <a href="https://markwatson.com">https://markwatson.com</a>.</p>
  <h2 id="book-cover">Book Cover</h2>
  <p>I live in Sedona, Arizona. I took the book cover photo in January 2023 from the street that I live on.</p>
  <h2 id="acknowledgements">Acknowledgements</h2>
  <p>This picture shows me and my wife Carol who helps me with book production and editing.</p>
  <div>
  <div class="figure-wrapper center"><figure class="image block" style="width: 50%"><img alt="Mark and Carol Watson" src="/site_images1/langchain/markcarol.jpg" style="width: 100%;"><figcaption>Mark and Carol Watson</figcaption></figure></div>
  </div>
  <p>I would also like to thank the following readers who reported errors or typos in this book: Armando Flores.</p>
  <h2 id="requirements-for-running-and-modifying-book-examples">Requirements for Running and Modifying Book Examples</h2>
  <p>I show full source code and a fair amount of example output for each book example so if you don’t want to get access to some of the following APIs then you can still read along in the book.</p>
  <p>To use OpenAI’s GPT-3 and ChatGPT models you will need to sign up for an API key (free tier is OK) at <a href="https://openai.com/api/">https://openai.com/api/</a> and set the environment variable <strong>OPENAI_API_KEY</strong> to your key value.</p>
  <p>You will need to get an API key for examples using <strong>Google’s Knowledge Graph APIs</strong>.</p>
  <p>Reference: <a href="https://cloud.google.com/enterprise-knowledge-graph/docs/search-api">Google Knowledge Graph APIs</a>.</p>
  <p>The example programs using Google’s Knowledge Graph APIs assume that you have the file <strong>~/.google_api_key</strong> in your home directory that contains your key from <a href="https://console.cloud.google.com/apis">https://console.cloud.google.com/apis</a>.</p>
  <p>You will need to install <strong>SerpApi for examples integrating web search</strong>. Please reference: <a href="https://pypi.org/project/google-search-results/">PyPi project page</a>.</p>
  <p>You can sign up for a free non-commercial 100 searches/month account with an email address and phone number at <a href="https://serpapi.com/users/welcome">https://serpapi.com/users/welcome</a>.</p>
  <p>You will also need <a href="zapier.com">Zapier</a> account for the GMail and Google Calendar examples.</p>
  <p>After reading though this book, you can review the website <a href="https://github.com/hwchase17/langchain-hub">LangChainHub</a> which contains prompts, chains and agents that are useful for building LLM applications.</p>
  <h1 id="large-language-model-overview">Large Language Model Overview</h1>
  <p><a href="https://blogs.nvidia.com/blog/2022/10/10/llms-ai-horizon/">Large language models</a> are a subset of artificial intelligence that use deep learning and neural networks to process natural language. <a href="https://www.linkedin.com/pulse/chatgpt-tip-iceberg-paul-golding">Transformers</a> are a type of neural network architecture that can learn context in sequential data using self-attention mechanisms. They were introduced in 2017 by a team at Google Brain and have become popular for LLM research. Some examples of <a href="https://factored.ai/transformer-based-language-models/">transformer-based</a> LLMs are <a href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">BERT, GPT-3, T5 and Megatron-LM</a>.</p>
  <p>The main points we will discuss in this book are:</p>
  <ul>
  <li>LLMs are deep learning algorithms that can understand and generate natural language based on massive datasets.</li>
  <li>LLMs use techniques such as self-attention, masking, and fine-tuning to learn complex patterns and relationships in language. LLMs can understand and generate natural language because they use transformer models, which are a type of neural network that can process sequential data such as text using attention mechanisms. Attention mechanisms allow the model to focus on relevant parts of the input and output sequences while ignoring irrelevant ones.</li>
  <li>LLMs can perform various natural language processing (NLP) and natural language generation (NLG) tasks, such as summarization, translation, prediction, classification, and question answering.</li>
  <li>Even though LLMs were initially developed for NLP applications, LLMs have also shown potential in other domains such as computer vision and computational biology by leveraging their generalizable knowledge and transfer learning abilities.</li>
  </ul>
  <p><a href="https://en.wikipedia.org/wiki/BERT_(Language_model)">BERT models</a> are one of the first types of transformer models that were widely used. BERT was developed by Google AI Language in 2018. BERT models are a family of masked language models that use transformer architecture to learn bidirectional representations of natural language. BERT models can understand the meaning of ambiguous words by using the surrounding text as context. The “magic trick” here is that training data comes almost free because in masking models, you programatically chose random words, replace them with a missing word token, and the model is trained to predict the missing words. This process is repeated with massive amounts of training data from the web, books, etc.</p>
  <p>Here are some “papers with code” links for BERT (links are for code, paper links in the code repositories):</p>
  <ul>
  <li><a href="https://github.com/allenai/scibert">https://github.com/allenai/scibert</a></li>
  <li><a href="https://github.com/google-research/bert">https://github.com/google-research/bert</a></li>
  </ul>
  <h2 id="big-tech-businesses-vs-small-startups-using-large-language-models">Big Tech Businesses vs. Small Startups Using Large Language Models</h2>
  <p>Both Microsoft and Google play both sides of this business game: they want to sell cloud LLM services to developers and small startup companies and they would also like to achieve lock-in for their consumer services like Office 365, Google Docs and Sheets, etc.</p>
  <p>Microsoft has been integrating AI technology into workplace emails, slideshows, and spreadsheets as part of its ongoing partnership with OpenAI, the company behind ChatGPT. Microsoft’s Azure OpenAI service offers a powerful tool to enable these outcomes when leveraged with their data lake of more than two billion metadata and transactional elements.</p>
  <p>As I write this, Google has just opened a public wait list for their Bard AI/chat search service. I have used various Google APIs for years in code I write. I have no favorites in the battle between tech giants, rather I am mostly interested in what they build that I can use in my own projects.</p>
  <p>Hugging Face, which makes AI products and hosts those developed by other companies, is working on open-source rivals to ChatGPT and will <a href="https://iblnews.org/aws-partners-with-hugging-face-an-ai-startup-rival-to-chatgpt-working-on-open-source-models/">use AWS</a> for that as well. Cohere AI, Anthropic, Hugging Face, and Stability AI are some of the startups that are using OpenAI and Hugging Face APIs for their products. As I write this chapter, I view Hugging Face as a great source of specialized models. I love that Hugging Face models can be run via their APIs and also self-hosted on our own servers and sometimes even on our laptops. Hugging Face is a fantastic resource and even though I use their models much less frequently in this book than OpenAI APIs, you should embrace the hosting and open source flexibility of Hugging Face. Here I use OpenAI APIs because I want you to get set up and creating your own projects quickly.</p>
  <p>Dear reader, I didn’t write this book for developers working at established AI companies (although I hope such people find the material here useful!). I wrote this book for small developers who want to scratch their own itch by writing tools that save them time. I also wrote this book hoping that it would help developers build capabilities into the programs they design and write that rival what the big tech companies are doing.</p>
  <h1 id="getting-started-with-langchain">Getting Started With LangChain</h1>
  <p>Harrison Chase started the LangChain project in October 2022 and as I write this book in February 2023 the GitHub repository for LangChain <a href="https://github.com/hwchase17/langchain">https://github.com/hwchase17/langchain</a> has 171 contributors.</p>
  <p><a href="https://langchain.readthedocs.io/en/latest/index.html">LangChain</a> is a framework for building applications with large language models (LLMs) through chaining different components together. Some of the applications of LangChain are chatbots, generative question-answering, summarization, data-augmented generation and more. LangChain can save time in building chatbots and other systems by providing a standard interface for chains, agents and memory, as well as integrations with other tools and end-to-end examples. We refer to “chains” as sequences of calls (to an LLMs and a different program utilities, cloud services, etc.) that go beyond just one LLM API call. LangChain provides a standard interface for chains, many integrations with other tools, and end-to-end chains for common applications. Often you will find existing chains already written that meet the requirements for your applications.</p>
  <p>For example, one can create a chain that takes user input, formats it using a PromptTemplate, and then passes the formatted response to a Large Language Model (LLM) for processing.</p>
  <p>While LLMs are very general in nature which means that while they can perform many tasks effectively, they often can not directly provide specific answers to questions or tasks that require deep domain knowledge or expertise. LangChain provides a standard interface for agents, a library of agents to choose from, and examples of end-to-end agents.</p>
  <p>LangChain Memory is the concept of persisting state between calls of a chain or agent. LangChain provides a standard interface for memory, a collection of memory implementations, and examples of chains/agents that use memory². LangChain provides a large collection of common utils to use in your application. Chains go beyond just a single LLM call, and are sequences of calls (whether to an LLM or a different utility). LangChain provides a standard interface for chains, lots of integrations with other tools, and end-to-end chains for common applications.</p>
  <p>LangChain can be integrated with one or more model providers, data stores, APIs, etc. LangChain can be used for in-depth question-and-answer chat sessions, API interaction, or action-taking. LangChain can be integrated with Zapier’s platform through a natural language API interface (we have an entire chapter dedicated to Zapier integrations).</p>
  <h2 id="installing-necessary-packages">Installing Necessary Packages</h2>
  <p>For the purposes of examples in this book, you might want to create a new Anaconda or other Python environment and install:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span>pip install langchain llama_index openai
  <span class="linenos">2 </span>pip install kor pydrive pandas rdflib 
  <span class="linenos">3 </span>pip install google-search-results SPARQLWrapper
  </pre></div>
  </figure>
  <p>For the rest of this chapter we will use the subdirectory <strong>langchain_getting_started</strong> and in the next chapter use <strong>llama-index_case_study</strong> in the GitHub repository for this book.</p>
  <h2 id="creating-a-new-langchain-project">Creating a New LangChain Project</h2>
  <p>Simple LangChain projects are often just a very short Python script file. As you read this book, when any example looks interesting or useful, I suggest copying the requirements.txt and Python source files to a new directory and making your own GitHub private repository to work in. Please make the examples in this book “your code,” that is, freely reuse any code or ideas you find here.</p>
  <h2 id="basic-usage-and-examples">Basic Usage and Examples</h2>
  <p>While I try to make the material in this book independent, something you can enjoy with no external references, you should also take advantage of the high quality [documentation](Langchain Quickstart Guide) and the individual detailed guides for prompts, chat, document loading, indexes, etc.</p>
  <p>As we work through some examples please keep in mind what it is like to use the ChatGPT web application: you enter text and get repsonses. The way you prompt ChatGPT is obviously important if you want to get useful responses. In code examples we automate and formalize this manual process.</p>
  <p>You need to choose a LLM to use. We will usually choose the GPT-3.5 API from OpenAI because it is general purpose and much less expensive than OpenAI’s previous model APIs. You will need to <a href="https://platform.openai.com/account/api-keys">sign up</a> for an API key and set it as an environment variable:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span><span class="k">export</span> <span class="n">OPENAI_API_KEY</span><span class="o">=</span><span class="s2">"YOUR KEY GOES HERE"</span>
  </pre></div>
  </figure>
  <p>Both the libraries <strong>openai</strong> and <strong>langchain</strong> will look for this environment variable and use it. We will look at a few simple examples in a Python REPL. We will start by just using OpenAI’s text prediction API:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python
  <span class="linenos"> 2 </span><span class="go">&gt;&gt;&gt; from langchain.llms import OpenAI</span>
  <span class="linenos"> 3 </span><span class="go">&gt;&gt;&gt; llm = OpenAI(temperature=0.8)</span>
  <span class="linenos"> 4 </span><span class="go">&gt;&gt;&gt; s = llm("John got into his new sports car, and he dro\</span>
  <span class="linenos"> 5 </span><span class="go">ve it")</span>
  <span class="linenos"> 6 </span><span class="go">&gt;&gt;&gt; s</span>
  <span class="linenos"> 7 </span><span class="go">' to work\n\nJohn started up his new sports car and drove\</span>
  <span class="linenos"> 8 </span><span class="go"> it to work. He had a huge smile on his face as he drove,</span>
  <span class="linenos"> 9 </span><span class="go"> excited to show off his new car to his colleagues. The w</span>
  <span class="linenos">10 </span><span class="go">ind blowing through his hair, and the sun on his skin, he</span>
  <span class="linenos">11 </span><span class="go"> felt a sense of freedom and joy as he cruised along the </span>
  <span class="linenos">12 </span><span class="go">road. He arrived at work in no time, feeling refreshed an</span>
  <span class="linenos">13 </span><span class="go">d energized.'</span>
  <span class="linenos">14 </span><span class="go">&gt;&gt;&gt; s = llm("John got into his new sports car, and he dro\</span>
  <span class="linenos">15 </span><span class="go">ve it")</span>
  <span class="linenos">16 </span><span class="go">&gt;&gt;&gt; s</span>
  <span class="linenos">17 </span><span class="go">" around town\n\nJohn drove his new sports car around tow\</span>
  <span class="linenos">18 </span><span class="go">n, enjoying the feeling of the wind in his hair. He stopp</span>
  <span class="linenos">19 </span><span class="go">ed to admire the view from a scenic lookout, and then spe</span>
  <span class="linenos">20 </span><span class="go">d off to the mall to do some shopping. On the way home, h</span>
  <span class="linenos">21 </span><span class="go">e took a detour down a winding country road, admiring the</span>
  <span class="linenos">22 </span><span class="go"> scenery and enjoying the feel of the car's powerful engi</span>
  <span class="linenos">23 </span><span class="go">ne. By the time he arrived back home, he had a huge smile</span>
  <span class="linenos">24 </span><span class="go"> on his face."</span>
  </pre></div>
  </figure>
  <p>Notice how when we ran the same input text prompt twice that we see different results.mSetting the temperature in line 3 to a higher value increases the randomness.</p>
  <p>Our next example is in the source file <strong>directions_template.py</strong> and uses the <strong>PromptTemplate</strong> class. A prompt template is a reproducible way to generate a prompt. It contains a text string (“the template”), that can take in a set of parameters from the end user and generate a prompt. The prompt template may contain language model instructions, few-shot examples to improve the model’s response, or specific questions for the model to answer.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>
  <span class="linenos"> 3 </span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="k">def</span> <span class="nf">get_directions</span><span class="p">(</span><span class="n">thing_to_do</span><span class="p">):</span>
  <span class="linenos"> 6 </span>    <span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
  <span class="linenos"> 7 </span>        <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">"thing_to_do"</span><span class="p">],</span>
  <span class="linenos"> 8 </span>        <span class="n">template</span><span class="o">=</span><span class="s2">"How do I </span><span class="si">{thing_to_do}</span><span class="s2">?"</span><span class="p">,</span>
  <span class="linenos"> 9 </span>    <span class="p">)</span>
  <span class="linenos">10 </span>    <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thing_to_do</span><span class="o">=</span><span class="n">thing_to_do</span><span class="p">)</span>
  <span class="linenos">11 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="n">prompt_text</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
  <span class="linenos">12 </span>    <span class="k">return</span> <span class="n">llm</span><span class="p">(</span><span class="n">prompt_text</span><span class="p">)</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span><span class="nb">print</span><span class="p">(</span><span class="n">get_directions</span><span class="p">(</span><span class="s2">"get to the store"</span><span class="p">))</span>
  <span class="linenos">15 </span><span class="nb">print</span><span class="p">(</span><span class="n">get_directions</span><span class="p">(</span><span class="s2">"hang a picture on the wall"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>You could just write Python string manipulation code to create a prompt but using the utiltiy class <strong>PromptTemplate</strong> is more legible and works with any number of prompt input variables.</p>
  <p>The output is:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python directions_template.py
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="go">How do I get to the store?:</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="go">To get to the store, you will need to use a mode of trans\</span>
  <span class="linenos"> 6 </span><span class="go">portation such as walking, driving, biking, or taking pub</span>
  <span class="linenos"> 7 </span><span class="go">lic transportation. Depending on the location of the stor</span>
  <span class="linenos"> 8 </span><span class="go">e, you may need to look up directions or maps to determin</span>
  <span class="linenos"> 9 </span><span class="go">e the best route to take.</span>
  <span class="linenos">10 </span>
  <span class="linenos">11 </span><span class="go">How do I hang a picture on the wall?:</span>
  <span class="linenos">12 </span>
  <span class="linenos">13 </span><span class="go">1. Find a stud in the wall, or use two or three wall anch\</span>
  <span class="linenos">14 </span><span class="go">ors for heavier pictures.</span>
  <span class="linenos">15 </span><span class="go">2. Measure and mark the wall where the picture hanger wil\</span>
  <span class="linenos">16 </span><span class="go">l go. </span>
  <span class="linenos">17 </span><span class="go">3. Pre-drill the holes and place wall anchors if needed.</span>
  <span class="linenos">18 </span><span class="go">4. Hammer the picture hanger into the holes.</span>
  <span class="linenos">19 </span><span class="go">5. Hang the picture on the picture hanger.</span>
  </pre></div>
  </figure>
  <p>The next example in the file <strong>country_information.py</strong> is derived from an example in the LangChain documentation. In this example we use <strong>PromptTemplate</strong> that contains the pattern we would like the LLM to use when returning a response.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>
  <span class="linenos"> 3 </span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="k">def</span> <span class="nf">get_country_information</span><span class="p">(</span><span class="n">country_name</span><span class="p">):</span>
  <span class="linenos"> 6 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Processing </span><span class="si">{</span><span class="n">country_name</span><span class="si">}</span><span class="s2">:"</span><span class="p">)</span>
  <span class="linenos"> 7 </span>    <span class="k">global</span> <span class="n">prompt</span>
  <span class="linenos"> 8 </span>    <span class="k">if</span> <span class="s2">"prompt"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
  <span class="linenos"> 9 </span>        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating prompt..."</span><span class="p">)</span>
  <span class="linenos">10 </span>        <span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
  <span class="linenos">11 </span>            <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">"country_name"</span><span class="p">],</span>
  <span class="linenos">12 </span>            <span class="n">template</span> <span class="o">=</span> <span class="s2">"""</span>
  <span class="linenos">13 </span><span class="s2">Predict the capital and population of a country.</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="s2">Country: </span><span class="si">{country_name}</span><span class="s2"></span>
  <span class="linenos">16 </span><span class="s2">Capital:</span>
  <span class="linenos">17 </span><span class="s2">Population:"""</span><span class="p">,</span>
  <span class="linenos">18 </span>        <span class="p">)</span>
  <span class="linenos">19 </span>    <span class="n">prompt_text</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">country_name</span><span class="o">=</span><span class="n">country_name</span><span class="p">)</span>
  <span class="linenos">20 </span>    <span class="nb">print</span><span class="p">(</span><span class="n">prompt_text</span><span class="p">)</span>
  <span class="linenos">21 </span>    <span class="k">return</span> <span class="n">llm</span><span class="p">(</span><span class="n">prompt_text</span><span class="p">)</span>
  <span class="linenos">22 </span>
  <span class="linenos">23 </span><span class="nb">print</span><span class="p">(</span><span class="n">get_country_information</span><span class="p">(</span><span class="s2">"Canada"</span><span class="p">))</span>
  <span class="linenos">24 </span><span class="nb">print</span><span class="p">(</span><span class="n">get_country_information</span><span class="p">(</span><span class="s2">"Germany"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>You can use the ChatGPT web interface to experiment with prompts and when you find a pattern that works well then write a Python script like the last example, but changing the data you supply in the <strong>PromptTemplate</strong> instance.</p>
  <p>The output of the last example is:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp"> $ </span>python country_information.py
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="go">Processing Canada:</span>
  <span class="linenos"> 4 </span><span class="go">Creating prompt...</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="go">Predict the capital and population of a country.</span>
  <span class="linenos"> 7 </span>
  <span class="linenos"> 8 </span><span class="go">Country: Canada</span>
  <span class="linenos"> 9 </span><span class="go">Capital:</span>
  <span class="linenos">10 </span><span class="go">Population:</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span>
  <span class="linenos">13 </span><span class="go">Capital: Ottawa</span>
  <span class="linenos">14 </span><span class="go">Population: 37,058,856 (as of July 2020)</span>
  <span class="linenos">15 </span>
  <span class="linenos">16 </span><span class="go">Processing Germany:</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="go">Predict the capital and population of a country.</span>
  <span class="linenos">19 </span>
  <span class="linenos">20 </span><span class="go">Country: Germany</span>
  <span class="linenos">21 </span><span class="go">Capital:</span>
  <span class="linenos">22 </span><span class="go">Population:</span>
  <span class="linenos">23 </span>
  <span class="linenos">24 </span>
  <span class="linenos">25 </span><span class="go">Capital: Berlin</span>
  <span class="linenos">26 </span><span class="go">Population: 83,02 million (est. 2019)</span>
  </pre></div>
  </figure>
  <h2 id="creating-embeddings">Creating Embeddings</h2>
  <p>We will reference the <a href="https://langchain.readthedocs.io/en/latest/modules/indexes/examples/embeddings.html">LangChain embeddings documentation</a>. We can use a Python REPL to see what text to vector space embeddings might look like:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python
  <span class="linenos"> 2 </span><span class="go">Python 3.10.8 (main, Nov 24 2022, 08:08:27) [Clang 14.0.6\</span>
  <span class="linenos"> 3 </span><span class="go"> ] on darwin</span>
  <span class="linenos"> 4 </span><span class="go">Type "help", "copyright", "credits" or "license" for more\</span>
  <span class="linenos"> 5 </span><span class="go"> information.</span>
  <span class="linenos"> 6 </span><span class="go">&gt;&gt;&gt; from langchain.embeddings import OpenAIEmbeddings</span>
  <span class="linenos"> 7 </span><span class="go">&gt;&gt;&gt; embeddings = OpenAIEmbeddings()</span>
  <span class="linenos"> 8 </span><span class="go">&gt;&gt;&gt; text = "Mary has blond hair and John has brown hair. \</span>
  <span class="linenos"> 9 </span><span class="go">Mary lives in town and John lives in the country."</span>
  <span class="linenos">10 </span><span class="go">&gt;&gt;&gt; doc_embeddings = embeddings.embed_documents([text])</span>
  <span class="linenos">11 </span><span class="go">&gt;&gt;&gt; doc_embeddings</span>
  <span class="linenos">12 </span><span class="go">[[0.007727328687906265, 0.0009025644976645708, -0.0033224\</span>
  <span class="linenos">13 </span><span class="go">383369088173, -0.01794492080807686, -0.017969949170947075</span>
  <span class="linenos">14 </span><span class="go">, 0.028506645932793617, -0.013414892368018627, 0.00466768</span>
  <span class="linenos">15 </span><span class="go">16418766975, -0.0024965214543044567, -0.02662956342101097</span>
  <span class="linenos">16 </span><span class="go">,</span>
  <span class="linenos">17 </span><span class="go">...]]</span>
  <span class="linenos">18 </span><span class="go">&gt;&gt;&gt; query_embedding = embeddings.embed_query("Does John l\</span>
  <span class="linenos">19 </span><span class="go">ive in the city?")</span>
  <span class="linenos">20 </span><span class="go">&gt;&gt;&gt; query_embedding</span>
  <span class="linenos">21 </span><span class="go">[0.028048301115632057, 0.011499025858938694, -0.009440079\</span>
  <span class="linenos">22 </span><span class="go">33139801, -0.020809611305594444, -0.023904507979750633, 0</span>
  <span class="linenos">23 </span><span class="go">.018750663846731186, -0.01626438833773136, 0.018129095435</span>
  <span class="linenos">24 </span><span class="go">142517,</span>
  <span class="linenos">25 </span><span class="go">...]</span>
  <span class="linenos">26 </span><span class="go">&gt;&gt;&gt;</span>
  </pre></div>
  </figure>
  <p>Notice that the <strong>doc_embeddings</strong> is a list where each list element is the embeddings for one input text document. The <strong>query_embedding</strong> is a single embedding. Please read the above linked embedding documentation.</p>
  <p>We will use vector stores to store calculated embeddings for future use. In the next chapter we will see a document database search example using LangChain and Llama-Index.</p>
  <h2 id="using-langchain-vector-stores-to-query-documents">Using LangChain Vector Stores to Query Documents</h2>
  <p>We will reference the <a href="https://langchain.readthedocs.io/en/latest/modules/indexes/examples/vectorstores.html">LangChain Vector Stores documentation</a>. You need to install a few libraries:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span>pip install chroma
  <span class="linenos">2 </span>pip install chromadb
  <span class="linenos">3 </span>pip install unstructured
  </pre></div>
  </figure>
  <p>The example script is <strong>doc_search.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">CharacterTextSplitter</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">Chroma</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">langchain.embeddings</span> <span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">DirectoryLoader</span>
  <span class="linenos"> 5 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">VectorDBQA</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="n">loader</span> <span class="o">=</span> <span class="n">DirectoryLoader</span><span class="p">(</span><span class="s1">'../data/'</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="s2">"**/*.txt"</span><span class="p">)</span>
  <span class="linenos">10 </span><span class="n">documents</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
  <span class="linenos">11 </span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">CharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span> <span class="n">ch</span>\
  <span class="linenos">12 </span><span class="n">unk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span><span class="n">texts</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos">15 </span>
  <span class="linenos">16 </span><span class="n">docsearch</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="n">qa</span> <span class="o">=</span> <span class="n">VectorDBQA</span><span class="o">.</span><span class="n">from_chain_type</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">OpenAI</span><span class="p">(),</span>
  <span class="linenos">19 </span>                                <span class="n">chain_type</span><span class="o">=</span><span class="s2">"stuff"</span><span class="p">,</span>
  <span class="linenos">20 </span>                                <span class="n">vectorstore</span><span class="o">=</span><span class="n">docsearch</span><span class="p">)</span>
  <span class="linenos">21 </span>
  <span class="linenos">22 </span><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
  <span class="linenos">23 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Query: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">24 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Answer: </span><span class="si">{</span><span class="n">qa</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">25 </span>
  <span class="linenos">26 </span><span class="n">query</span><span class="p">(</span><span class="s2">"What kinds of equipment are in a chemistry laborat</span><span class="se">\</span>
  <span class="linenos">27 </span><span class="s2">ory?"</span><span class="p">)</span>
  <span class="linenos">28 </span><span class="n">query</span><span class="p">(</span><span class="s2">"What is Austrian School of Economics?"</span><span class="p">)</span>
  <span class="linenos">29 </span><span class="n">query</span><span class="p">(</span><span class="s2">"Why do people engage in sports?"</span><span class="p">)</span>
  <span class="linenos">30 </span><span class="n">query</span><span class="p">(</span><span class="s2">"What is the effect of body chemistry on exercise?"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>The <strong>DirectoryLoader</strong> class is useful for loading a directory full of input documents. It this example we specified that we only want to process text files, but the file matching pattern could have also specified PDF files, etc.</p>
  <p>The output is:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python doc_search.py      
  <span class="linenos"> 2 </span><span class="go">Created a chunk of size 1055, which is longer than the sp\</span>
  <span class="linenos"> 3 </span><span class="go">ecified 1000</span>
  <span class="linenos"> 4 </span><span class="go">Running Chroma using direct local API.</span>
  <span class="linenos"> 5 </span><span class="go">Using DuckDB in-memory for database. Data will be transie\</span>
  <span class="linenos"> 6 </span><span class="go">nt.</span>
  <span class="linenos"> 7 </span><span class="go">Query: What kinds of equipment are in a chemistry laborat\</span>
  <span class="linenos"> 8 </span><span class="go">ory?</span>
  <span class="linenos"> 9 </span><span class="go">Answer:  A chemistry lab would typically include glasswar\</span>
  <span class="linenos">10 </span><span class="go">e, such as beakers, flasks, and test tubes, as well as ot</span>
  <span class="linenos">11 </span><span class="go">her equipment such as scales, Bunsen burners, and thermom</span>
  <span class="linenos">12 </span><span class="go">eters.</span>
  <span class="linenos">13 </span><span class="go">Query: What is Austrian School of Economics?</span>
  <span class="linenos">14 </span><span class="go">Answer:  The Austrian School is a school of economic thou\</span>
  <span class="linenos">15 </span><span class="go">ght that emphasizes the spontaneous organizing power of t</span>
  <span class="linenos">16 </span><span class="go">he price mechanism. Austrians hold that the complexity of</span>
  <span class="linenos">17 </span><span class="go"> subjective human choices makes mathematical modelling of</span>
  <span class="linenos">18 </span><span class="go"> the evolving market extremely difficult and advocate a "</span>
  <span class="linenos">19 </span><span class="go">laissez faire" approach to the economy. Austrian School e</span>
  <span class="linenos">20 </span><span class="go">conomists advocate the strict enforcement of voluntary co</span>
  <span class="linenos">21 </span><span class="go">ntractual agreements between economic agents, and hold th</span>
  <span class="linenos">22 </span><span class="go">at commercial transactions should be subject to the small</span>
  <span class="linenos">23 </span><span class="go">est possible imposition of forces they consider to be (in</span>
  <span class="linenos">24 </span><span class="go"> particular the smallest possible amount of government in</span>
  <span class="linenos">25 </span><span class="go">tervention). The Austrian School derives its name from it</span>
  <span class="linenos">26 </span><span class="go">s predominantly Austrian founders and early supporters, i</span>
  <span class="linenos">27 </span><span class="go">ncluding Carl Menger, Eugen von Bohm-Bawerk and Ludwig vo</span>
  <span class="linenos">28 </span><span class="go">n Mises.</span>
  <span class="linenos">29 </span><span class="go">Query: Why do people engage in sports?</span>
  <span class="linenos">30 </span><span class="go">Answer:  People engage in sports for leisure and entertai\</span>
  <span class="linenos">31 </span><span class="go">nment, as well as for physical exercise and athleticism.</span>
  <span class="linenos">32 </span><span class="go">Query: What is the effect of body chemistry on exercise?</span>
  <span class="linenos">33 </span><span class="go">Answer:  Body chemistry can affect the body's response to\</span>
  <span class="linenos">34 </span><span class="go"> exercise, as certain hormones and enzymes produced by th</span>
  <span class="linenos">35 </span><span class="go">e body can affect the energy levels and muscle performanc</span>
  <span class="linenos">36 </span><span class="go">e. Chemicals in the body, such as adenosine triphosphate </span>
  <span class="linenos">37 </span><span class="gp gp-VirtualEnv">(ATP)</span> <span class="go">and urea, can affect the body's energy production a</span>
  <span class="linenos">38 </span><span class="go">nd muscle metabolism during exercise. Additionally, the b</span>
  <span class="linenos">39 </span><span class="go">ody's levels of electrolytes, vitamins, and minerals can </span>
  <span class="linenos">40 </span><span class="go">affect exercise performance.</span>
  <span class="linenos">41 </span><span class="go">Exiting: Cleaning up .chroma directory</span>
  </pre></div>
  </figure>
  <h2 id="langchain-overview-wrap-up">LangChain Overview Wrap Up</h2>
  <p>We will continue using LangChain for the rest of this book as well as the LlamaIndex library that we introduce in the next chapter.</p>
  <p>I cover just the subset of LangChain that I use in my own projects in this book. I urge you to read the LangChain documentation and to explore public LangChain chains that users have written on <a href="https://github.com/hwchase17/langchain-hub">Langchain-hub</a>.</p>
  <h1 id="overview-of-llamaindex">Overview of LlamaIndex</h1>
  <p>The popular LlamaIndex project used to be called GPT-Index but has been generalized to work with more models that just GPT-3, for example <a href="https://gpt-index.readthedocs.io/en/latest/how_to/embeddings.html">using Hugging Face embeddings</a>.</p>
  <p><a href="https://github.com/jerryjliu/gpt_index/blob/main/docs/index.rst">LlamaIndex</a> is a project that provides a central interface to connect your language models with external data. It was created by Jerry Liu and his team in the fall of 2022. It consists of a set of data structures <a href="https://gpt-index.readthedocs.io/en/latest/index.html">designed to make it easier to use large external knowledge bases with language models</a>. Some of its uses are:</p>
  <ul>
  <li>Querying structured data such as tables or databases using natural language</li>
  <li>Retrieving relevant facts or information from large text corpora</li>
  <li>Enhancing language models with domain-specific knowledge</li>
  </ul>
  <p>LlamaIndex supports a variety of document types, including:</p>
  <ul>
  <li>Text documents are the most common type of document. They can be stored in a variety of formats, such as .txt, .doc, and .pdf.</li>
  <li>XML documents are a type of text document that is used to store data in a structured format.</li>
  <li>JSON documents are a type of text document that is used to store data in a lightweight format.</li>
  <li>HTML documents are a type of text document that is used to create web pages.</li>
  <li>PDF documents are a type of text document that is used to store documents in a fixed format.</li>
  </ul>
  <p>LlamaIndex can also index data that is stored in a variety of databases, including:</p>
  <ul>
  <li>SQL databases such as MySQL, PostgreSQL, and Oracle.
  NoSQL databases such as MongoDB, Cassandra, and CouchDB.</li>
  <li>Solr is a popular open-source search engine that provides high performance and scalability.</li>
  <li>Elasticsearch is another popular open-source search engine that offers a variety of features, including full-text search, geospatial search, and machine learning.</li>
  <li>Apache Cassandra is a NoSQL database that can be used to store large amounts of data.</li>
  <li>MongoDB is another NoSQL database that is easy to use and scale.</li>
  <li>PostgreSQL is a relational database that is widely used in enterprise applications.</li>
  </ul>
  <p>LlamaIndex is a flexible framework that can be used to index a variety of document types and data sources.</p>
  <p>We will look first at a short example derived from the LlamaIndex documentation and later look at the parts of the LlmaIndex source code that uses LangChain.</p>
  <h2 id="using-llamaindex-to-search-local-documents-using-gpt-3">Using LlamaIndex to Search Local Documents Using GPT-3</h2>
  <p>The following example is similar to the last example in the overview chapter on LangChain. In line 8 we use a utility data loader function provided by LlamaIndex to read documents in an input directory. As a demonstration we save the index (consisting of document embeddings) to disk and reload it. This technique is useful when you have a large number of static documents so the indexing procedure can take a while and require many OpenAI API calls. As an example, you might have many gigabytes of company documentation that doesn’t change often so it makes sense to only occasionally recreate the index.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="c1"># Derived from a documentation example at:</span>
  <span class="linenos"> 2 </span><span class="c1"># https://github.com/jerryjliu/gpt_index</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="c1"># make sure you set the following environment variable</span>
  <span class="linenos"> 5 </span><span class="c1"># is set: OPENAI_API_KEY</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">,</span>
  <span class="linenos"> 8 </span>                        <span class="n">SimpleDirectoryReader</span>
  <span class="linenos"> 9 </span><span class="n">documents</span> <span class="o">=</span> <span class="n">SimpleDirectoryReader</span><span class="p">(</span><span class="s1">'../data'</span><span class="p">)</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
  <span class="linenos">10 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="c1"># save to disk</span>
  <span class="linenos">13 </span><span class="n">index</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="s1">'index.json'</span><span class="p">)</span>
  <span class="linenos">14 </span><span class="c1"># load from disk</span>
  <span class="linenos">15 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTSimpleVectorIndex</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="s1">'index.json'</span><span class="p">)</span>
  <span class="linenos">16 </span>
  <span class="linenos">17 </span><span class="c1"># search for a document</span>
  <span class="linenos">18 </span><span class="n">r</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"effect of body chemistry on exercise?"</span><span class="p">)</span>
  <span class="linenos">19 </span><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>You may have noticed that the query defined on line 17 is the same query that we used last chapter.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total LLM token \</span>
  <span class="linenos"> 2 </span><span class="go">usage: 0 tokens</span>
  <span class="linenos"> 3 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total embedding \</span>
  <span class="linenos"> 4 </span><span class="go">token usage: 2272 tokens</span>
  <span class="linenos"> 5 </span><span class="go">INFO:root:&gt; [query] Total LLM token usage: 1018 tokens</span>
  <span class="linenos"> 6 </span><span class="go">INFO:root:&gt; [query] Total embedding token usage: 7 tokens</span>
  <span class="linenos"> 7 </span>
  <span class="linenos"> 8 </span><span class="go">The effect of body chemistry on exercise can vary dependi\</span>
  <span class="linenos"> 9 </span><span class="go">ng on the individual. Factors such as hydration levels, e</span>
  <span class="linenos">10 </span><span class="go">lectrolyte balance, and the availability of energy-storin</span>
  <span class="linenos">11 </span><span class="go">g molecules such as adenosine triphosphate (ATP) can all </span>
  <span class="linenos">12 </span><span class="go">affect the bodys ability to perform exercise. Additionall</span>
  <span class="linenos">13 </span><span class="go">y, hormones such as adrenaline and cortisol can influence</span>
  <span class="linenos">14 </span><span class="go"> the bodys response to exercise, as can the presence of c</span>
  <span class="linenos">15 </span><span class="go">ertain nutrients and minerals.</span>
  </pre></div>
  </figure>
  <p>Note that in general, many organic chemicals could be listed in response to the query <strong>effect of body chemistry on exercise?</strong> but that just <strong>adenosine triphosphate (ATP)</strong> was mentioned in the test document in the file <strong>data/chemistry.txt</strong>.</p>
  <h2 id="using-llamaindex-for-question-answering-from-a-list-of-web-sites">Using LlamaIndex for Question Answering from a List of Web Sites</h2>
  <p>In this example we use the <strong>trafilatura</strong> and <strong>html2text</strong> libraries to get text from a web page that we will index and search. The class <strong>TrafilaturaWebReader</strong> does the work of creating local documents from a list of web page URIs and the index class <strong>GPTListIndex</strong> builds a local index for use with OpenAI API calls to implement search.</p>
  <p>The following listing shows the file <strong>web_page_QA.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="c1"># Derived from the example at:</span>
  <span class="linenos"> 2 </span><span class="c1"># https://github.com/jerryjliu/gpt_index/blob/main/exampl\</span>
  <span class="linenos"> 3 </span><span class="n">es</span><span class="o">/</span><span class="n">data_connectors</span><span class="o">/</span><span class="n">WebPageDemo</span><span class="o">.</span><span class="n">ipynb</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="c1"># pip install llama-index, html2text, trafilatura</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTListIndex</span>
  <span class="linenos"> 8 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">TrafilaturaWebReader</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="k">def</span> <span class="nf">query_website</span><span class="p">(</span><span class="n">url_list</span><span class="p">,</span> <span class="o">*</span><span class="n">questions</span><span class="p">):</span>
  <span class="linenos">11 </span>    <span class="n">documents</span> <span class="o">=</span> <span class="n">TrafilaturaWebReader</span><span class="p">()</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">url_list</span><span class="p">)</span>
  <span class="linenos">12 </span>    <span class="n">index</span> <span class="o">=</span> <span class="n">GPTListIndex</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos">13 </span>    <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
  <span class="linenos">14 </span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">== QUESTION: </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">15 </span>        <span class="n">response</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
  <span class="linenos">16 </span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"== RESPONSE: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">19 </span>  <span class="n">url_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"https://markwatson.com"</span><span class="p">]</span>
  <span class="linenos">20 </span>  <span class="n">query_website</span><span class="p">(</span><span class="n">url_list</span><span class="p">,</span> <span class="s2">"What programming languages doe</span><span class="se">\</span>
  <span class="linenos">21 </span><span class="s2">s Mark use?"</span><span class="p">,</span>
  <span class="linenos">22 </span>                          <span class="s2">"How many books has Mark writte</span><span class="se">\</span>
  <span class="linenos">23 </span><span class="s2">n?"</span><span class="p">,</span>
  <span class="linenos">24 </span>                          <span class="s2">"What musical instruments does </span><span class="se">\</span>
  <span class="linenos">25 </span><span class="s2">Mark play?"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>This example is not efficient because we create a new index for each web page we want to search. That said, this example (that was derived from an example in the LlamaIndex documentation) implements a pattern that you can use, for example, to build a reusable index of your company’s web site and build an end-user web search app.</p>
  <p>The output for these three test questions in the last code example is:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">build_index_from_documents</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
  <span class="linenos"> 2 </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos"> 3 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">build_index_from_documents</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="err">\</span><span class="w"></span>
  <span class="linenos"> 4 </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="o">==</span><span class="w"> </span><span class="nl">QUESTION</span><span class="p">:</span><span class="w"> </span><span class="n">What</span><span class="w"> </span><span class="n">programming</span><span class="w"> </span><span class="n">languages</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="k">use</span><span class="vm">?</span><span class="w"></span>
  <span class="linenos"> 7 </span>
  <span class="linenos"> 8 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">2210</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos"> 9 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos">10 </span><span class="o">==</span><span class="w"> </span><span class="nl">RESPONSE</span><span class="p">:</span><span class="w"> </span>
  <span class="linenos">11 </span><span class="n">Mark</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">variety</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">programming</span><span class="w"> </span><span class="n">languages</span><span class="p">,</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">H</span><span class="err">\</span><span class="w"></span>
  <span class="linenos">12 </span><span class="n">askell</span><span class="p">,</span><span class="w"> </span><span class="n">Ruby</span><span class="p">,</span><span class="w"> </span><span class="n">Clojure</span><span class="p">,</span><span class="w"> </span><span class="n">JavaScript</span><span class="p">,</span><span class="w"> </span><span class="n">Java</span><span class="p">,</span><span class="w"> </span><span class="n">Common</span><span class="w"> </span><span class="n">Lisp</span><span class="p">,</span><span class="w"> </span><span class="n">Pyt</span><span class="w"></span>
  <span class="linenos">13 </span><span class="n">hon</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Smalltalk</span><span class="p">.</span><span class="w"></span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="o">==</span><span class="w"> </span><span class="nl">QUESTION</span><span class="p">:</span><span class="w"> </span><span class="n">How</span><span class="w"> </span><span class="n">many</span><span class="w"> </span><span class="n">books</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="n">written</span><span class="vm">?</span><span class="w"></span>
  <span class="linenos">16 </span>
  <span class="linenos">17 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">2189</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos">18 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos">19 </span><span class="o">==</span><span class="w"> </span><span class="nl">RESPONSE</span><span class="p">:</span><span class="w"> </span>
  <span class="linenos">20 </span><span class="n">Mark</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">written</span><span class="w"> </span><span class="mi">20</span><span class="o">+</span><span class="w"> </span><span class="n">books</span><span class="p">.</span><span class="w"></span>
  <span class="linenos">21 </span>
  <span class="linenos">22 </span><span class="o">==</span><span class="w"> </span><span class="nl">QUESTION</span><span class="p">:</span><span class="w"> </span><span class="n">What</span><span class="w"> </span><span class="n">musical</span><span class="w"> </span><span class="n">instruments</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="n">play</span><span class="vm">?</span><span class="w"></span>
  <span class="linenos">23 </span>
  <span class="linenos">24 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">2197</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos">25 </span><span class="nl">INFO</span><span class="p">:</span><span class="nl">root</span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">query</span><span class="o">]</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="n">embedding</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="k">usage</span><span class="err">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">tokens</span><span class="w"></span>
  <span class="linenos">26 </span><span class="o">==</span><span class="w"> </span><span class="nl">RESPONSE</span><span class="p">:</span><span class="w"> </span>
  <span class="linenos">27 </span><span class="n">Mark</span><span class="w"> </span><span class="n">plays</span><span class="w"> </span><span class="n">guitar</span><span class="p">,</span><span class="w"> </span><span class="n">didgeridoo</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">American</span><span class="w"> </span><span class="n">Indian</span><span class="w"> </span><span class="n">flute</span><span class="p">.</span><span class="w"></span>
  </pre></div>
  </figure>
  <h2 id="llamaindexgpt-index-case-study-wrap-up">LlamaIndex/GPT-Index Case Study Wrap Up</h2>
  <p>LlamaIndex is a set of data structures and library code designed to make it easier to use large external knowledge bases such as Wikipedia. LlamaIndex creates a vectorized index from your document data, making it highly efficient to query. It then uses this index to identify the most relevant sections of the document based on the query.</p>
  <p>LlamaIndex is useful because it provides a central interface to connect your LLM’s with external data and offers data connectors to your existing data sources and data formats (API’s, PDF’s, docs, SQL, etc.). It provides a simple, flexible interface between your external data and LLMs.</p>
  <p>Some projects that use LlamaIndex include building personal assistants with LlamaIndex and GPT-3.5, using LlamaIndex for document retrieval, and combining answers across documents.</p>
  <h1 id="using-googles-knowledge-graph-apis-with-langchain">Using Google’s Knowledge Graph APIs With LangChain</h1>
  <p>Google’s Knowledge Graph (KG) is a knowledge base that Google uses to serve relevant information in an infobox beside its search results. It allows the user to see the answer in a glance, as an instant answer. The data is generated automatically from a variety of sources, covering places, people, businesses, and more. I worked at Google in 2013 on a project that used their KG for an internal project.</p>
  <p>Google’s public Knowledge Graph Search API lets you find entities in the Google Knowledge Graph. The API uses standard schema.org types and is compliant with the JSON-LD specification. It supports entity search and lookup.</p>
  <p>You can use the Knowledge Graph Search API to build applications that make use of Google’s Knowledge Graph. For example, you can use the API to build a search engine that returns results based on the entities in the Knowledge Graph.</p>
  <p>In the next chapter we also use the public KGs DBPedia and Wikidata. One limitation of Google’s KG APIs is that it is designed for entity (people, places, organizations, etc.) lookup. When DBPedia and Wikidata it is possible to find a wider range of information using the SPARQL query language, such as relationships between entities. You can use the Google KG APIs to find some entity relationships, e.g., all the movies directed by a particular director, or all the books written by a particular author. You can also use the API to find information like all the people who have worked on a particular movie, or all the actors who have appeared in a particular TV show.</p>
  <h2 id="setting-up-to-access-google-knowledge-graph-apis">Setting Up To Access Google Knowledge Graph APIs</h2>
  <p>To get an API key for Google’s Knowledge Graph Search API, you need to go to the Google API Console, enable the Google Knowledge Graph Search API, and create an API key to use in your project. You can then use this API key to make requests to the Knowledge Graph Search API.</p>
  <p>To create your application’s API key, follow these steps:</p>
  <ul>
  <li>Go to the API Console.</li>
  <li>From the projects list, select a project or create a new one.</li>
  <li>If the APIs &amp; services page isn’t already open, open the left side menu and select APIs &amp; services.</li>
  <li>On the left, choose Credentials.</li>
  <li>Click Create credentials and then select API key.</li>
  </ul>
  <p>You can then use this API key to make requests to the Knowledge Graph Search APIs.</p>
  <p>When I use Google’s APIs I set the access key in <strong>~/.google_api_key</strong> and read in the key using:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span><span class="n">api_key</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span><span class="o">+</span><span class="s2">"/.google_api_key"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  </pre></div>
  </figure>
  <p>You can also use environment variables to store access keys. Here is a code snippet for making an API call to get information about me:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">import</span> <span class="nn">json</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
  <span class="linenos"> 5 </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="n">api_key</span> <span class="o">=</span>
  <span class="linenos"> 8 </span>    <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span> <span class="o">+</span> <span class="s2">"/.google_api_key"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  <span class="linenos"> 9 </span><span class="n">query</span> <span class="o">=</span> <span class="s2">"Mark Louis Watson"</span>
  <span class="linenos">10 </span><span class="n">service_url</span> <span class="o">=</span>
  <span class="linenos">11 </span>    <span class="s2">"https://kgsearch.googleapis.com/v1/entities:search"</span>
  <span class="linenos">12 </span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="linenos">13 </span>    <span class="s2">"query"</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
  <span class="linenos">14 </span>    <span class="s2">"limit"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="linenos">15 </span>    <span class="s2">"indent"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="linenos">16 </span>    <span class="s2">"key"</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
  <span class="linenos">17 </span><span class="p">}</span>
  <span class="linenos">18 </span><span class="n">url</span> <span class="o">=</span> <span class="n">service_url</span> <span class="o">+</span> <span class="s2">"?"</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="linenos">19 </span><span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="linenos">20 </span><span class="n">pprint</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>The JSON-LD output would look like:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="go">{'@context': {'@vocab': 'http://schema.org/',</span>
  <span class="linenos"> 2 </span><span class="go">              'EntitySearchResult':</span>
  <span class="linenos"> 3 </span><span class="go">              'goog:EntitySearchResult',</span>
  <span class="linenos"> 4 </span><span class="go">              'detailedDescription':</span>
  <span class="linenos"> 5 </span><span class="go">              'goog:detailedDescription',</span>
  <span class="linenos"> 6 </span><span class="go">              'goog': 'http://schema.googleapis.com/',</span>
  <span class="linenos"> 7 </span><span class="go">              'kg': 'http://g.co/kg',</span>
  <span class="linenos"> 8 </span><span class="go">              'resultScore': 'goog:resultScore'},</span>
  <span class="linenos"> 9 </span><span class="go"> '@type': 'ItemList',</span>
  <span class="linenos">10 </span><span class="go"> 'itemListElement': [{'@type': 'EntitySearchResult',</span>
  <span class="linenos">11 </span><span class="go">                      'result': {'@id': 'kg:/m/0b6_g82',</span>
  <span class="linenos">12 </span><span class="go">                                 '@type': ['Thing',</span>
  <span class="linenos">13 </span><span class="go">                                           'Person'],</span>
  <span class="linenos">14 </span><span class="go">                                 'description': 'Author',</span>
  <span class="linenos">15 </span><span class="go">                                 'name':</span>
  <span class="linenos">16 </span><span class="go">                                 'Mark Louis Watson',</span>
  <span class="linenos">17 </span><span class="go">                                 'url':</span>
  <span class="linenos">18 </span><span class="go">                                 'http://markwatson.com'},</span>
  <span class="linenos">19 </span><span class="go">                      'resultScore': 43}]}</span>
  </pre></div>
  </figure>
  <p>In order to not repeat the code for getting entity information from the Google KG, I wrote a utility <strong>Google_KG_helper.py</strong> that encapsulates the previous code and generalizes it into a mini-library:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="sd">"""Client for calling Knowledge Graph Search API."""</span>
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="kn">import</span> <span class="nn">json</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>
  <span class="linenos"> 5 </span><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
  <span class="linenos"> 6 </span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
  <span class="linenos"> 7 </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="n">api_key</span> <span class="o">=</span>
  <span class="linenos">10 </span>    <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span> <span class="o">+</span> <span class="s2">"/.google_api_key"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="c1"># use Google search API to get information</span>
  <span class="linenos">13 </span><span class="c1"># about a named entity:</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="k">def</span> <span class="nf">get_entity_info</span><span class="p">(</span><span class="n">entity_name</span><span class="p">):</span>
  <span class="linenos">16 </span>    <span class="n">service_url</span> <span class="o">=</span>
  <span class="linenos">17 </span>      <span class="s2">"https://kgsearch.googleapis.com/v1/entities:search"</span>
  <span class="linenos">18 </span>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="linenos">19 </span>        <span class="s2">"query"</span><span class="p">:</span> <span class="n">entity_name</span><span class="p">,</span>
  <span class="linenos">20 </span>        <span class="s2">"limit"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="linenos">21 </span>        <span class="s2">"indent"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="linenos">22 </span>        <span class="s2">"key"</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
  <span class="linenos">23 </span>    <span class="p">}</span>
  <span class="linenos">24 </span>    <span class="n">url</span> <span class="o">=</span> <span class="n">service_url</span> <span class="o">+</span> <span class="s2">"?"</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="linenos">25 </span>    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="linenos">26 </span>    <span class="k">return</span> <span class="n">response</span>
  <span class="linenos">27 </span>
  <span class="linenos">28 </span><span class="k">def</span> <span class="nf">tree_traverse</span><span class="p">(</span><span class="n">a_dict</span><span class="p">):</span>
  <span class="linenos">29 </span>    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="linenos">30 </span>    <span class="k">def</span> <span class="nf">recur</span><span class="p">(</span><span class="n">dict_2</span><span class="p">,</span> <span class="n">a_list</span><span class="p">):</span>
  <span class="linenos">31 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_2</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
  <span class="linenos">32 </span>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict_2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="linenos">33 </span>                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span>
  <span class="linenos">34 </span>                           <span class="s1">'articleBody'</span><span class="p">]:</span>
  <span class="linenos">35 </span>                    <span class="n">a_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
  <span class="linenos">36 </span>                <span class="n">recur</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">a_list</span><span class="p">)</span>
  <span class="linenos">37 </span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
  <span class="linenos">38 </span>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dict_2</span><span class="p">:</span>
  <span class="linenos">39 </span>                <span class="n">recur</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a_list</span><span class="p">)</span>
  <span class="linenos">40 </span>    <span class="n">recur</span><span class="p">(</span><span class="n">a_dict</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
  <span class="linenos">41 </span>    <span class="k">return</span> <span class="n">ret</span>
  <span class="linenos">42 </span>
  <span class="linenos">43 </span>
  <span class="linenos">44 </span><span class="k">def</span> <span class="nf">get_context_text</span><span class="p">(</span><span class="n">entity_name</span><span class="p">):</span>
  <span class="linenos">45 </span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">get_entity_info</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
  <span class="linenos">46 </span>    <span class="k">return</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_traverse</span><span class="p">(</span><span class="n">json_data</span><span class="p">))</span>
  <span class="linenos">47 </span>
  <span class="linenos">48 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">49 </span>    <span class="n">get_context_text</span><span class="p">(</span><span class="s2">"Bill Clinton"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>The main test script is in the file <strong>Google_Knowledge_Graph_Search.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="sd">"""Example of Python client calling the</span>
  <span class="linenos"> 2 </span><span class="sd">   Knowledge Graph Search API."""</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTListIndex</span><span class="p">,</span> <span class="n">Document</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="kn">import</span> <span class="nn">Google_KG_helper</span>
  <span class="linenos"> 7 </span>
  <span class="linenos"> 8 </span><span class="k">def</span> <span class="nf">kg_search</span><span class="p">(</span><span class="n">entity_name</span><span class="p">,</span> <span class="o">*</span><span class="n">questions</span><span class="p">):</span>
  <span class="linenos"> 9 </span>    <span class="n">ret</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="linenos">10 </span>    <span class="n">context_text</span> <span class="o">=</span>
  <span class="linenos">11 </span>      <span class="n">Google_KG_helper</span><span class="o">.</span><span class="n">get_context_text</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)</span>
  <span class="linenos">12 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Context text: </span><span class="si">{</span><span class="n">context_text</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">13 </span>    <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span><span class="n">context_text</span><span class="p">)</span>
  <span class="linenos">14 </span>    <span class="n">index</span> <span class="o">=</span> <span class="n">GPTListIndex</span><span class="p">([</span><span class="n">doc</span><span class="p">])</span>
  <span class="linenos">15 </span>    <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
  <span class="linenos">16 </span>        <span class="n">response</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
  <span class="linenos">17 </span>        <span class="n">ret</span> <span class="o">+=</span>
  <span class="linenos">18 </span>          <span class="sa">f</span><span class="s2">"QUESTION:  </span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="se">\n</span><span class="s2">RESPONSE: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
  <span class="linenos">19 </span>    <span class="k">return</span> <span class="n">ret</span>
  <span class="linenos">20 </span>
  <span class="linenos">21 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">22 </span>    <span class="n">s</span> <span class="o">=</span> <span class="n">kg_search</span><span class="p">(</span><span class="s2">"Bill Clinton"</span><span class="p">,</span>
  <span class="linenos">23 </span>                  <span class="s2">"When was Bill president?"</span><span class="p">)</span>
  <span class="linenos">24 </span>    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>The example output is:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python Google_Knowledge_Graph_Search.py
  <span class="linenos"> 2 </span><span class="go">Context text: Bill Clinton 42nd U.S. President William Je\</span>
  <span class="linenos"> 3 </span><span class="go">fferson Clinton is an American retired politician who ser</span>
  <span class="linenos"> 4 </span><span class="go">ved as the 42nd president of the United States from 1993 </span>
  <span class="linenos"> 5 </span><span class="go">to 2001. </span>
  <span class="linenos"> 6 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total LLM token \</span>
  <span class="linenos"> 7 </span><span class="go">usage: 0 tokens</span>
  <span class="linenos"> 8 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total embedding \</span>
  <span class="linenos"> 9 </span><span class="go">token usage: 0 tokens</span>
  <span class="linenos">10 </span><span class="go">INFO:root:&gt; [query] Total LLM token usage: 77 tokens</span>
  <span class="linenos">11 </span><span class="go">INFO:root:&gt; [query] Total embedding token usage: 0 tokens</span>
  <span class="linenos">12 </span><span class="go">QUESTION:  When was Bill president?</span>
  <span class="linenos">13 </span><span class="go">RESPONSE: </span>
  <span class="linenos">14 </span><span class="go">Bill Clinton was president from 1993 to 2001.</span>
  </pre></div>
  </figure>
  <p>Accessing Knowledge Graphs from Google, DBPedia, and Wikidata allows you to integrate real world facts and knowledge with your applications. While I mostly work in the field of deep learning I frequently also use Knowledge Graphs in my work and in my personal research. I think that you, dear reader, might find accessing highly structured data in KGs to be more reliable and in many cases simpler than using web scraping.</p>
  <h1 id="using-dbpedia-and-wikidata-as-knowledge-sources">Using DBPedia and WikiData as Knowledge Sources</h1>
  <p>Both <a href="https://www.dbpedia.org">DBPedia</a> and <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page">Wikidata</a> are public Knowledge Graphs (KGs) that store data as <a href="https://www.w3.org/RDF/">Resource Description Framework (RDF)</a> and are accessed through the <a href="https://www.w3.org/TR/rdf-sparql-query/">SPARQL Query Language for RDF</a>. The examples for this project are in the <a href="https://github.com/mark-watson/langchain-book-examples">GitHub repository for this book</a> in the directory <strong>kg_search</strong>.</p>
  <p>I am not going to spend much time here discussing RDF and SPARQL. Instead I ask you to read online the introductory chapter <strong>Linked Data, the Semantic Web, and Knowledge Graphs</strong> in my book <a href="https://leanpub.com/hy-lisp-python/read">A Lisp Programmer Living in Python-Land: The Hy Programming Language</a>.</p>
  <p>As we saw in the last chapter, a Knowledge Graph (that I often abbreviate as KG) is a graph database using a schema to define types (both objects and relationships between objects) and properties that link property values to objects. The term “Knowledge Graph” is both a general term and also sometimes refers to the specific Knowledge Graph used at Google which I worked with while working there in 2013. Here, we use KG to reference the general technology of storing knowledge in graph databases.</p>
  <p>DBPedia and Wikidata are similar, with some important differences. Here is a summary of some similarities and differences between DBPedia and Wikidata:</p>
  <ul>
  <li>Both projects aim to provide structured data from Wikipedia in various formats and languages. Wikidata also has data from other sources so it contains more data and more languages.</li>
  <li>Both projects use RDF as a common data model and SPARQL as a query language.</li>
  <li>DBPedia extracts data from the infoboxes in Wikipedia articles, while Wikidata collects data entered through its interfaces by both users and automated bots.</li>
  <li>Wikidata requires sources for its data, while DBPedia does not.</li>
  <li>DBpedia is more popular in the Semantic Web and Linked Open Data communities, while Wikidata is more integrated with Wikimedia projects.</li>
  </ul>
  <p>To the last point: I personally prefer DBPedia when experimenting with the semantic web and linked data, mostly because DBPedia URIs are human readable while Wikidata URIs are abstract. The following URIs represent the town I live in, Sedona Arizona:</p>
  <ul>
  <li>DBPedia: https://dbpedia.org/page/Sedona,_Arizona</li>
  <li>Wikidata: https://www.wikidata.org/wiki/Q80041</li>
  </ul>
  <p>In RDF we enclose URIs in angle brackets like <strong>&lt;https://www.wikidata.org/wiki/Q80041&gt;</strong>.</p>
  <p>If you read the chapter on RDF and SPARQL in my book link that I mentioned previously, then you know that RDF data is represented by triples where each part is named:</p>
  <ul>
  <li>subject</li>
  <li>property</li>
  <li>object</li>
  </ul>
  <p>We will look at two similar examples in this chapter, one using DBPedia and one using Wikidata. Both services have SPARQL endpoint web applications that you will want to use for exploring both KGs. We will look at the DBPedia web interface later. Here is the Wikidata web interface:</p>
  <div class="figure-wrapper center"><figure class="image block" style="width: 144px"><img alt="" src="/site_images1/langchain/wikidata.png" style="width: 100%;"><figcaption></figcaption></figure></div>
  <p>In this SPARQL query the prefix <strong>wd:</strong> stands for Wikidata data while the prefix <strong>wdt:</strong> stands for Wikidata type (or property). The prefix <strong>rdfs:</strong> stands for RDF Schema.</p>
  <h2 id="using-dbpedia-as-a-data-source">Using DBPedia as a Data Source</h2>
  <p>DBpedia is a community-driven project that extracts structured content from Wikipedia and makes it available on the web as a Knowledge Graph (KG). The KG is a valuable resource for researchers and developers who need to access structured data from Wikipedia. With the use of SPARQL queries to DBpedia as a data source we can write a variety applications, including natural language processing, machine learning, and data analytics. We demonstrate the effectiveness of DBpedia as a data source by presenting several examples that illustrate its use in real-world applications. In my experience, DBpedia is a valuable resource for researchers and developers who need to access structured data from Wikipedia.</p>
  <p>In general you will start projects using DBPedia by exploring available data using the web app <a href="https://dbpedia.org/sparql">https://dbpedia.org/sparql</a> that can be seen in this screen shot:</p>
  <div class="figure-wrapper center"><figure class="image block" style="width: 144px"><img alt="" src="/site_images1/langchain/dbpedia.png" style="width: 100%;"><figcaption></figcaption></figure></div>
  <p>The following listing of file <strong>dbpedia_generate_rdf_as_nt.py</strong> shows Python code for making a SPARQL query to DBPedia and saving the results as RDF triples in NT format in a local text file:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">SPARQLWrapper</span> <span class="kn">import</span> <span class="n">SPARQLWrapper</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="n">sparql</span> <span class="o">=</span> <span class="n">SPARQLWrapper</span><span class="p">(</span><span class="s2">"http://dbpedia.org/sparql"</span><span class="p">)</span>
  <span class="linenos"> 5 </span><span class="n">sparql</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="s2">"""</span>
  <span class="linenos"> 6 </span><span class="s2">    PREFIX dbpedia-owl: &lt;http://dbpedia.org/ontology/&gt;</span>
  <span class="linenos"> 7 </span><span class="s2">    PREFIX dbpedia: &lt;http://dbpedia.org/resource&gt;</span>
  <span class="linenos"> 8 </span><span class="s2">    PREFIX dbpprop: &lt;http://dbpedia.org/property&gt;</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="s2">    CONSTRUCT {</span>
  <span class="linenos">11 </span><span class="s2">        ?city dbpedia-owl:country ?country .</span>
  <span class="linenos">12 </span><span class="s2">        ?city rdfs:label ?citylabel .</span>
  <span class="linenos">13 </span><span class="s2">        ?country rdfs:label ?countrylabel .</span>
  <span class="linenos">14 </span><span class="s2">        &lt;http://dbpedia.org/ontology/country&gt; rdfs:label </span><span class="se">\</span>
  <span class="linenos">15 </span><span class="s2">"country"@en .</span>
  <span class="linenos">16 </span><span class="s2">    }</span>
  <span class="linenos">17 </span><span class="s2">    WHERE {</span>
  <span class="linenos">18 </span><span class="s2">        ?city rdf:type dbpedia-owl:City .</span>
  <span class="linenos">19 </span><span class="s2">        ?city rdfs:label ?citylabel .</span>
  <span class="linenos">20 </span><span class="s2">        ?city dbpedia-owl:country ?country .</span>
  <span class="linenos">21 </span><span class="s2">        ?country rdfs:label ?countrylabel .</span>
  <span class="linenos">22 </span><span class="s2">        FILTER (lang(?citylabel) = 'en')</span>
  <span class="linenos">23 </span><span class="s2">        FILTER (lang(?countrylabel) = 'en')</span>
  <span class="linenos">24 </span><span class="s2">    }</span>
  <span class="linenos">25 </span><span class="s2">    LIMIT 50</span>
  <span class="linenos">26 </span><span class="s2">"""</span><span class="p">)</span>
  <span class="linenos">27 </span><span class="n">sparql</span><span class="o">.</span><span class="n">setReturnFormat</span><span class="p">(</span><span class="s2">"rdf"</span><span class="p">)</span>
  <span class="linenos">28 </span><span class="n">results</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
  <span class="linenos">29 </span>
  <span class="linenos">30 </span><span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
  <span class="linenos">31 </span><span class="n">g</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">"xml"</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"xml</span><span class="se">\</span>
  <span class="linenos">32 </span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">33 </span>
  <span class="linenos">34 </span><span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">results:</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">35 </span><span class="n">results</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">"nt"</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span>\
  <span class="linenos">36 </span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
  <span class="linenos">37 </span><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
  <span class="linenos">38 </span>
  <span class="linenos">39 </span><span class="n">text_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"sample.nt"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span>
  <span class="linenos">40 </span><span class="n">text_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
  <span class="linenos">41 </span><span class="n">text_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  </pre></div>
  </figure>
  <p>Here is the printed output from running this script (most output not shown, and manually edited to fit page width):</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp"> $ </span>python generate_rdf_as_nt.py
  <span class="linenos"> 2 </span><span class="go">results:</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="go">&lt;http://dbpedia.org/resource/Ethiopia&gt;</span>
  <span class="linenos"> 5 </span><span class="go">    &lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</span>
  <span class="linenos"> 6 </span><span class="go">    "Ethiopia"@en .</span>
  <span class="linenos"> 7 </span><span class="go">&lt;http://dbpedia.org/resource/Valentin_Alsina,_Buenos_Aire\</span>
  <span class="linenos"> 8 </span><span class="go">s&gt;</span>
  <span class="linenos"> 9 </span><span class="go">    &lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</span>
  <span class="linenos">10 </span><span class="go">    "Valentin Alsina, Buenos Aires"@en .</span>
  <span class="linenos">11 </span><span class="go">&lt;http://dbpedia.org/resource/Davyd-Haradok&gt;</span>
  <span class="linenos">12 </span><span class="go">    &lt;http://dbpedia.org/ontology/country&gt;</span>
  <span class="linenos">13 </span><span class="go">    &lt;http://dbpedia.org/resource/Belarus&gt; .</span>
  <span class="linenos">14 </span><span class="go">&lt;http://dbpedia.org/resource/Davyd-Haradok&gt;</span>
  <span class="linenos">15 </span><span class="go">    &lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</span>
  <span class="linenos">16 </span><span class="go">    "Davyd-Haradok"@en .</span>
  <span class="linenos">17 </span><span class="go">&lt;http://dbpedia.org/resource/Belarus&gt;</span>
  <span class="linenos">18 </span><span class="go">    &lt;http://www.w3.org/2000/01/rdf-schema#label&gt;</span>
  <span class="linenos">19 </span><span class="go">    "Belarus"@en .</span>
  <span class="linenos">20 </span><span class="go"> ...</span>
  </pre></div>
  </figure>
  <p>This output was written to a local file <strong>sample.nt</strong>. I divided this example into two separate Python scripts because I thought it would be easier for you, dear reader, to experiment with fetching RDF data separately from using a LLM to process the RDF data. In production you may want to combine KG queries with semantic analysis.</p>
  <p>This code example demonstrates the use of the <strong>GPTSimpleVectorIndex</strong> for querying RDF data and retrieving information about countries. The function <strong>download_loader</strong> loads data importers by string name. While it is not a type safe to load a Python class by name using a string, if you misspell the name of the class to load the call to <strong>download_loader</strong> then a Python <strong>ValueError(“Loader class name not found in library”)</strong> error is thrown. The GPTSimpleVectorIndex class represents an index data structure that can be used to efficiently search and retrieve information from the RDF data. This is similar to other types of LlamaIndex vector index types for different types of data sources.</p>
  <p>Here is the script <strong>dbpedia_rdf_query.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="s2">"Example from documentation"</span>
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">,</span> <span class="n">Document</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">download_loader</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="n">RDFReader</span> <span class="o">=</span> <span class="n">download_loader</span><span class="p">(</span><span class="s2">"RDFReader"</span><span class="p">)</span>
  <span class="linenos"> 7 </span><span class="n">doc</span> <span class="o">=</span> <span class="n">RDFReader</span><span class="p">()</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s2">"sample.nt"</span><span class="p">)</span>
  <span class="linenos"> 8 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="n">result</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"list all countries in a quoted Pyth</span><span class="se">\</span>
  <span class="linenos">11 </span><span class="s2">on array, then explain why"</span><span class="p">)</span>
  <span class="linenos">12 </span>
  <span class="linenos">13 </span><span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>Here is the output:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python rdf_query.py
  <span class="linenos"> 2 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total LLM token \</span>
  <span class="linenos"> 3 </span><span class="go">usage: 0 tokens</span>
  <span class="linenos"> 4 </span><span class="go">INFO:root:&gt; [build_index_from_documents] Total embedding \</span>
  <span class="linenos"> 5 </span><span class="go">token usage: 761 tokens</span>
  <span class="linenos"> 6 </span><span class="go">INFO:root:&gt; [query] Total LLM token usage: 921 tokens</span>
  <span class="linenos"> 7 </span><span class="go">INFO:root:&gt; [query] Total embedding token usage: 12 tokens</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="go">['Argentina', 'French Polynesia', 'Democratic Republic of\</span>
  <span class="linenos">10 </span><span class="go"> the Congo', 'Benin', 'Ethiopia', 'Australia', 'Uzbekista</span>
  <span class="linenos">11 </span><span class="go">n', 'Tanzania', 'Albania', 'Belarus', 'Vanuatu', 'Armenia</span>
  <span class="linenos">12 </span><span class="go">', 'Syria', 'Andorra', 'Venezuela', 'France', 'Vietnam', </span>
  <span class="linenos">13 </span><span class="go">'Azerbaijan']</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="go">This is a list of all the countries mentioned in the cont\</span>
  <span class="linenos">16 </span><span class="go">ext information. All of the countries are listed in the c</span>
  <span class="linenos">17 </span><span class="go">ontext information, so this list is complete.</span>
  </pre></div>
  </figure>
  <p>Why are there only 18 countries listed? In the script used to perform a SPARQL query on DBPedia, we had a statement <strong>LIMIT 50</strong> at the end of the query so only 50 RDF triples were written to the file <strong>sample.nt</strong> that only contains data for 18 countries.</p>
  <h2 id="using-wikidata-as-a-data-source">Using Wikidata as a Data Source</h2>
  <p>It is slightly more difficult exploring Wikidata compared to DBPedia. Let’s revisit getting information about my home town of Sedona Arizona.</p>
  <p>In writing this example, I experimented with SPARQL queries using the <a href="https://query.wikidata.org">Wikidata SPARQL web app</a>.</p>
  <p>We can start by finding RDF statements with the object value being “Sedona” using the Wikidata web app:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span><span class="k">select</span> <span class="o">*</span> <span class="k">where</span> <span class="p">{</span>
  <span class="linenos">2 </span>  <span class="nv">?s</span> <span class="nv">?p</span> <span class="s">"Sedona"</span><span class="o">@</span><span class="nf">en</span>
  <span class="linenos">3 </span><span class="p">}</span> <span class="k">LIMIT</span> <span class="mi">30</span>
  </pre></div>
  </figure>
  <p>First we write a helper utility to gather prompt text for an entity name (e.g., name of a person, place, etc.) in the file <strong>wikidata_generate_prompt_text.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">SPARQLWrapper</span> <span class="kn">import</span> <span class="n">SPARQLWrapper</span><span class="p">,</span> <span class="n">JSON</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">rdflib</span> <span class="kn">import</span> <span class="n">Graph</span>
  <span class="linenos"> 3 </span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="k">def</span> <span class="nf">get_possible_eitity_uris_from_wikidata</span><span class="p">(</span><span class="n">entity_name</span><span class="p">):</span>
  <span class="linenos"> 6 </span>   <span class="n">sparql</span> <span class="o">=</span> <span class="n">SPARQLWrapper</span><span class="p">(</span><span class="s2">"https://query.wikidata.org/spa</span><span class="se">\</span>
  <span class="linenos"> 7 </span><span class="s2">rql"</span><span class="p">)</span>
  <span class="linenos"> 8 </span>   <span class="n">sparql</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="s2">"""</span>
  <span class="linenos"> 9 </span><span class="s2">      SELECT ?entity ?entityLabel WHERE {</span>
  <span class="linenos">10 </span><span class="s2">         ?entity rdfs:label "</span><span class="si">%s</span><span class="s2">"@en .</span>
  <span class="linenos">11 </span><span class="s2">      } limit 5</span>
  <span class="linenos">12 </span><span class="s2">   """</span> <span class="o">%</span> <span class="n">entity_name</span><span class="p">)</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span>   <span class="n">sparql</span><span class="o">.</span><span class="n">setReturnFormat</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
  <span class="linenos">15 </span>   <span class="n">results</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
  <span class="linenos">16 </span>
  <span class="linenos">17 </span>   <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'bindin</span><span class="se">\</span>
  <span class="linenos">18 </span><span class="s1">gs'</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
  <span class="linenos">19 </span>   <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;"</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"&gt;"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
  <span class="linenos">20 </span>   <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="p">)]</span> <span class="c1"># remove duplicates</span>
  <span class="linenos">21 </span>
  <span class="linenos">22 </span><span class="k">def</span> <span class="nf">wikidata_query_to_df</span><span class="p">(</span><span class="n">entity_uri</span><span class="p">):</span>
  <span class="linenos">23 </span>   <span class="n">sparql</span> <span class="o">=</span> <span class="n">SPARQLWrapper</span><span class="p">(</span><span class="s2">"https://query.wikidata.org/spa</span><span class="se">\</span>
  <span class="linenos">24 </span><span class="s2">rql"</span><span class="p">)</span>
  <span class="linenos">25 </span>   <span class="n">sparql</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="s2">"""</span>
  <span class="linenos">26 </span><span class="s2">      SELECT ?description ?is_a_type_of WHERE {</span>
  <span class="linenos">27 </span><span class="s2">        </span><span class="si">%s</span><span class="s2"> schema:description ?description FILTER (lang(?</span><span class="se">\</span>
  <span class="linenos">28 </span><span class="s2">description) = 'en') .</span>
  <span class="linenos">29 </span><span class="s2">        </span><span class="si">%s</span><span class="s2"> wdt:P31 ?instanceOf .  </span>
  <span class="linenos">30 </span><span class="s2">        ?instanceOf rdfs:label ?is_a_type_of FILTER (lang</span><span class="se">\</span>
  <span class="linenos">31 </span><span class="s2">(?is_a_type_of) = 'en') .</span>
  <span class="linenos">32 </span><span class="s2">      } limit 10</span>
  <span class="linenos">33 </span><span class="s2">   """</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity_uri</span><span class="p">,</span> <span class="n">entity_uri</span><span class="p">))</span>
  <span class="linenos">34 </span>
  <span class="linenos">35 </span>   <span class="n">sparql</span><span class="o">.</span><span class="n">setReturnFormat</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
  <span class="linenos">36 </span>   <span class="n">results</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
  <span class="linenos">37 </span>   <span class="n">results2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'results'</span><span class="p">][</span><span class="s1">'bindi</span><span class="se">\</span>
  <span class="linenos">38 </span><span class="s1">ngs'</span><span class="p">])</span>
  <span class="linenos">39 </span>   <span class="n">prompt_text</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="linenos">40 </span>   <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results2</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
  <span class="linenos">41 </span>        <span class="n">prompt_text</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="s1">'description.value'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">" is a </span><span class="se">\</span>
  <span class="linenos">42 </span><span class="s2">type of "</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">'is_a_type_of.value'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> 
  <span class="linenos">43 </span>   <span class="k">return</span> <span class="n">prompt_text</span>
  <span class="linenos">44 </span>
  <span class="linenos">45 </span><span class="k">def</span> <span class="nf">generate_prompt_text</span><span class="p">(</span><span class="n">entity_name</span><span class="p">):</span>
  <span class="linenos">46 </span>   <span class="n">entity_uris</span> <span class="o">=</span> <span class="n">get_possible_eitity_uris_from_wikidata</span><span class="p">(</span><span class="n">e</span>\
  <span class="linenos">47 </span><span class="n">ntity_name</span><span class="p">)</span>
  <span class="linenos">48 </span>   <span class="n">prompt_text</span> <span class="o">=</span> <span class="s2">""</span>
  <span class="linenos">49 </span>   <span class="k">for</span> <span class="n">entity_uri</span> <span class="ow">in</span> <span class="n">entity_uris</span><span class="p">:</span>
  <span class="linenos">50 </span>       <span class="n">p</span> <span class="o">=</span> <span class="n">wikidata_query_to_df</span><span class="p">(</span><span class="n">entity_uri</span><span class="p">)</span>
  <span class="linenos">51 </span>       <span class="k">if</span> <span class="s2">"disambiguation page"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
  <span class="linenos">52 </span>           <span class="n">prompt_text</span> <span class="o">+=</span> <span class="n">entity_name</span> <span class="o">+</span> <span class="s2">" is "</span> <span class="o">+</span> <span class="n">wikidata</span>\
  <span class="linenos">53 </span><span class="n">_query_to_df</span><span class="p">(</span><span class="n">entity_uri</span><span class="p">)</span>
  <span class="linenos">54 </span>   <span class="k">return</span> <span class="n">prompt_text</span>
  <span class="linenos">55 </span>
  <span class="linenos">56 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">57 </span>   <span class="nb">print</span><span class="p">(</span><span class="s2">"Sedona:"</span><span class="p">,</span> <span class="n">generate_prompt_text</span><span class="p">(</span><span class="s2">"Sedona"</span><span class="p">))</span>
  <span class="linenos">58 </span>   <span class="nb">print</span><span class="p">(</span><span class="s2">"California:"</span><span class="p">,</span>
  <span class="linenos">59 </span>         <span class="n">generate_prompt_text</span><span class="p">(</span><span class="s2">"California"</span><span class="p">))</span>
  <span class="linenos">60 </span>   <span class="nb">print</span><span class="p">(</span><span class="s2">"Bill Clinton:"</span><span class="p">,</span>
  <span class="linenos">61 </span>         <span class="n">generate_prompt_text</span><span class="p">(</span><span class="s2">"Bill Clinton"</span><span class="p">))</span>
  <span class="linenos">62 </span>   <span class="nb">print</span><span class="p">(</span><span class="s2">"Donald Trump:"</span><span class="p">,</span>
  <span class="linenos">63 </span>          <span class="n">generate_prompt_text</span><span class="p">(</span><span class="s2">"Donald Trump"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>This utility does most of the work in getting prompt text for an entity.</p>
  <p>The <strong>GPTTreeIndex</strong> class is similar to other LlamaIndex index classes. This class builds a tree-based index of the prompt texts, which can be used to retrieve information based on the input question. In LlamaIndex, a <strong>GPTTreeIndex</strong> is used to select the child node(s) to send the query down to. A <strong>GPTKeywordTableIndex</strong> uses keyword matching, and a <strong>GPTVectorStoreIndex</strong> uses embedding cosine similarity. The choice of which index class to use depends on how much text is being indexed, what the granularity of subject matter in the text is, and if you want summarization.</p>
  <p><strong>GPTTreeIndex</strong> is also more efficient than <strong>GPTSimpleVectorIndex</strong> because it uses a tree structure to store the data. This allows for faster searching and retrieval of data compared to a linear list index class like <strong>GPTSimpleVectorIndex</strong>.</p>
  <p>The LlamaIndex code is relatively easy to implement in the script <strong>wikidata_query.py</strong> (edited to fit page width):</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">StringIterableReader</span><span class="p">,</span> <span class="n">GPTTreeIndex</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">wikidata_generate_prompt_text</span> <span class="kn">import</span> <span class="n">generate_prompt</span>\
  <span class="linenos"> 3 </span><span class="n">_text</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="k">def</span> <span class="nf">wd_query</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="o">*</span><span class="n">entity_names</span><span class="p">):</span>
  <span class="linenos"> 6 </span>    <span class="n">prompt_texts</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="linenos"> 7 </span>    <span class="k">for</span> <span class="n">entity_name</span> <span class="ow">in</span> <span class="n">entity_names</span><span class="p">:</span>
  <span class="linenos"> 8 </span>        <span class="n">prompt_texts</span> <span class="o">+=</span>
  <span class="linenos"> 9 </span>          <span class="p">[</span><span class="n">generate_prompt_text</span><span class="p">(</span><span class="n">entity_name</span><span class="p">)]</span>
  <span class="linenos">10 </span>    <span class="n">documents</span> <span class="o">=</span>
  <span class="linenos">11 </span>      <span class="n">StringIterableReader</span><span class="p">()</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">texts</span><span class="o">=</span><span class="n">prompt_texts</span><span class="p">)</span>
  <span class="linenos">12 </span>    <span class="n">index</span> <span class="o">=</span> <span class="n">GPTTreeIndex</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos">13 </span>    <span class="k">return</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">16 </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">"Sedona:"</span><span class="p">,</span> <span class="n">wd_query</span><span class="p">(</span><span class="s2">"What is Sedona?"</span><span class="p">,</span> <span class="s2">"Sedona"</span><span class="p">))</span>
  <span class="linenos">17 </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">"California:"</span><span class="p">,</span>
  <span class="linenos">18 </span>        <span class="n">wd_query</span><span class="p">(</span><span class="s2">"What is California?"</span><span class="p">,</span> <span class="s2">"California"</span><span class="p">))</span>
  <span class="linenos">19 </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">"Bill Clinton:"</span><span class="p">,</span>
  <span class="linenos">20 </span>    <span class="n">wd_query</span><span class="p">(</span><span class="s2">"When was Bill Clinton president?"</span><span class="p">,</span>
  <span class="linenos">21 </span>             <span class="s2">"Bill Clinton"</span><span class="p">))</span>
  <span class="linenos">22 </span>  <span class="nb">print</span><span class="p">(</span><span class="s2">"Donald Trump:"</span><span class="p">,</span>
  <span class="linenos">23 </span>    <span class="n">wd_query</span><span class="p">(</span><span class="s2">"Who is Donald Trump?"</span><span class="p">,</span>
  <span class="linenos">24 </span>             <span class="s2">"Donald Trump"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>Here is the test output (with some lines removed):</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python wikidata_query.py
  <span class="linenos"> 2 </span><span class="go">Total LLM token usage: 162 tokens</span>
  <span class="linenos"> 3 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [build_ind\</span>
  <span class="linenos"> 4 </span><span class="go">ex_from_documents] INFO:llama_index.indices.query.tree.le</span>
  <span class="linenos"> 5 </span><span class="go">af_query:&gt; Starting query: What is Sedona?</span>
  <span class="linenos"> 6 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [query] To\</span>
  <span class="linenos"> 7 </span><span class="go">tal LLM token usage: 154 tokens</span>
  <span class="linenos"> 8 </span><span class="go">Sedona: Sedona is a city in the United States located in \</span>
  <span class="linenos"> 9 </span><span class="go">the counties of Yavapai and Coconino, Arizona. It is also</span>
  <span class="linenos">10 </span><span class="go"> the title of a 2012 film, a company, and a 2015 single b</span>
  <span class="linenos">11 </span><span class="go">y Houndmouth.</span>
  <span class="linenos">12 </span>
  <span class="linenos">13 </span><span class="go">Total LLM token usage: 191 tokens</span>
  <span class="linenos">14 </span><span class="go">INFO:llama_index.indices.query.tree.leaf_query:&gt; Starting\</span>
  <span class="linenos">15 </span><span class="go"> query: What is California?</span>
  <span class="linenos">16 </span><span class="go">California: California is a U.S. state in the United Stat\</span>
  <span class="linenos">17 </span><span class="go">es of America.</span>
  <span class="linenos">18 </span>
  <span class="linenos">19 </span><span class="go">Total LLM token usage: 138 tokens</span>
  <span class="linenos">20 </span><span class="go">INFO:llama_index.indices.query.tree.leaf_query:&gt; Starting\</span>
  <span class="linenos">21 </span><span class="go"> query: When was Bill Clinton president?</span>
  <span class="linenos">22 </span><span class="go">Bill Clinton: Bill Clinton was the 42nd President of the \</span>
  <span class="linenos">23 </span><span class="go">United States from 1993 to 2001.</span>
  <span class="linenos">24 </span>
  <span class="linenos">25 </span><span class="go">Total LLM token usage: 159 tokens</span>
  <span class="linenos">26 </span><span class="go">INFO:llama_index.indices.query.tree.leaf_query:&gt; Starting\</span>
  <span class="linenos">27 </span><span class="go"> query: Who is Donald Trump?</span>
  <span class="linenos">28 </span><span class="go">Donald Trump: Donald Trump is the 45th President of the U\</span>
  <span class="linenos">29 </span><span class="go">nited States, serving from 2017 to 2021.</span>
  </pre></div>
  </figure>
  <h1 id="using-llms-to-organize-information-in-our-google-drives">Using LLMs To Organize Information in Our Google Drives</h1>
  <p>My digital life consists of writing, working as an AI practitioner, and learning activities that I justify with my self-image of a “gentleman scientist.” Cloud storage like GitHub, Google Drive, Microsoft OneDrive, and iCloud are central to my activities.</p>
  <p>About ten years ago I spent two months of my time writing a system in Clojure that was planned to be my own custom and personal DropBox, augmented with various NLP tools and a FireFox plugin to send web clippings directly to my personal system. To be honest, I stopped using my own project after a few months because the time it took to organize my information was a greater opportunity cost than the value I received.</p>
  <p>In this chapter I am going to walk you through parts of a new system that I am developing for my own personal use to help me organize my material on Google Drive (and eventually other cloud services). Don’t be surprised if the completed project is an additional example in a future edition of this book!</p>
  <p>With the Google setup directions listed below, you will get a pop-up web browsing window with a warning like (this shows my Gmail address, you should see your own Gmail address here assuming that you have recently logged into Gmail using your default web browser):</p>
  <div class="figure-wrapper center"><figure class="image block" style="width: 144px"><img alt="" src="/site_images1/langchain/gwarning.png" style="width: 100%;"><figcaption></figcaption></figure></div>
  <p>You will need to first click <strong>Advanced</strong> and then click link <strong>Go to GoogleAPIExamples (unsafe)</strong> link in the lower left corner and then temporarily authorize this example on your Gmail account.</p>
  <h2 id="setting-up-requirements">Setting Up Requirements.</h2>
  <p>You need to create a credential at <a href="https://console.cloud.google.com/cloud-resource-manager">https://console.cloud.google.com/cloud-resource-manager</a> (copied from the <a href="https://pythonhosted.org/PyDrive/quickstart.html">PyDrive documentation</a>, changing application type to “Desktop”):</p>
  <ul>
  <li>Search for ‘Google Drive API’, select the entry, and click ‘Enable’.</li>
  <li>Select ‘Credentials’ from the left menu, click ‘Create Credentials’, select ‘OAuth client ID’.</li>
  <li>Now, the product name and consent screen need to be set -&gt; click ‘Configure consent screen’ and follow the instructions. Once finished:</li>
  <li>Select ‘Application type’ to be Desktop application.</li>
  <li>Enter an appropriate name.</li>
  <li>Input http://localhost:8080 for ‘Authorized JavaScript origins’.</li>
  <li>Input http://localhost:8080/ for ‘Authorized redirect URIs’.</li>
  <li>Click ‘Save’.</li>
  <li>Click ‘Download JSON’ on the right side of Client ID to download client_secret_.json. Copy the downloaded JSON credential file to the example directory <strong>google_drive_llm</strong> for this chapter.</li>
  </ul>
  <h2 id="write-utility-to-fetch-all-text-files-from-top-level-google-drive-folder">Write Utility To Fetch All Text Files From Top Level Google Drive Folder</h2>
  <p>For this example we will just authenticate our test script with Google, and copy all top level text files with names ending with “.txt” to the local file system in subdirectory <strong>data</strong>. The code is in the directory <strong>google_drive_llm</strong> in file <strong>fetch_txt_files.py</strong> (edited to fit page width):</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">pydrive.auth</span> <span class="kn">import</span> <span class="n">GoogleAuth</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">pydrive.drive</span> <span class="kn">import</span> <span class="n">GoogleDrive</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="c1"># good GD search docs:</span>
  <span class="linenos"> 6 </span><span class="c1"># https://developers.google.com/drive/api/guides/search-f\</span>
  <span class="linenos"> 7 </span><span class="n">iles</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="c1"># Authenticate with Google</span>
  <span class="linenos">10 </span><span class="n">gauth</span> <span class="o">=</span> <span class="n">GoogleAuth</span><span class="p">()</span>
  <span class="linenos">11 </span><span class="n">gauth</span><span class="o">.</span><span class="n">LocalWebserverAuth</span><span class="p">()</span>
  <span class="linenos">12 </span><span class="n">drive</span> <span class="o">=</span> <span class="n">GoogleDrive</span><span class="p">(</span><span class="n">gauth</span><span class="p">)</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span><span class="k">def</span> <span class="nf">get_txt_files</span><span class="p">(</span><span class="n">dir_id</span><span class="o">=</span><span class="s1">'root'</span><span class="p">):</span>
  <span class="linenos">15 </span>    <span class="s2">" get all plain text files with .txt extension in top</span><span class="se">\</span>
  <span class="linenos">16 </span><span class="s2"> level Google Drive directory "</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span>    <span class="n">file_list</span> <span class="o">=</span> <span class="n">drive</span><span class="o">.</span><span class="n">ListFile</span><span class="p">({</span><span class="s1">'q'</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"'</span><span class="si">{</span><span class="n">dir_id</span><span class="si">}</span><span class="s2">' in pare</span><span class="se">\</span>
  <span class="linenos">19 </span><span class="s2">nts and trashed=false"</span><span class="p">})</span><span class="o">.</span><span class="n">GetList</span><span class="p">()</span>
  <span class="linenos">20 </span>    <span class="k">for</span> <span class="n">file1</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
  <span class="linenos">21 </span>        <span class="nb">print</span><span class="p">(</span><span class="s1">'title: </span><span class="si">%s</span><span class="s1">, id: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">file1</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span> <span class="n">file</span>\
  <span class="linenos">22 </span><span class="mi">1</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span>
  <span class="linenos">23 </span>    <span class="k">return</span> <span class="p">[[</span><span class="n">file1</span><span class="p">[</span><span class="s1">'title'</span><span class="p">],</span> <span class="n">file1</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="n">file1</span><span class="o">.</span><span class="n">GetConten</span>\
  <span class="linenos">24 </span><span class="n">tString</span><span class="p">()]</span>
  <span class="linenos">25 </span>            <span class="k">for</span> <span class="n">file1</span> <span class="ow">in</span> <span class="n">file_list</span>
  <span class="linenos">26 </span>              <span class="k">if</span> <span class="n">file1</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".txt"</span><span class="p">)]</span>
  <span class="linenos">27 </span>
  <span class="linenos">28 </span><span class="k">def</span> <span class="nf">create_test_file</span><span class="p">():</span>
  <span class="linenos">29 </span>    <span class="s2">" not currently used, but useful for testing. "</span>
  <span class="linenos">30 </span>
  <span class="linenos">31 </span>    <span class="c1"># Create GoogleDriveFile instance with title 'Hello.t\</span>
  <span class="linenos">32 </span><span class="n">xt</span><span class="s1">':</span>
  <span class="linenos">33 </span>    <span class="n">file1</span> <span class="o">=</span> <span class="n">drive</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">({</span><span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Hello.txt'</span><span class="p">})</span>
  <span class="linenos">34 </span>    <span class="n">file1</span><span class="o">.</span><span class="n">SetContentString</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">)</span>
  <span class="linenos">35 </span>    <span class="n">file1</span><span class="o">.</span><span class="n">Upload</span><span class="p">()</span>
  <span class="linenos">36 </span>
  <span class="linenos">37 </span><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
  <span class="linenos">38 </span>    <span class="n">fl</span> <span class="o">=</span> <span class="n">get_txt_files</span><span class="p">()</span>
  <span class="linenos">39 </span>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
  <span class="linenos">40 </span>        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="linenos">41 </span>        <span class="n">file1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"data/"</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">"w"</span><span class="p">)</span>
  <span class="linenos">42 </span>        <span class="n">file1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
  <span class="linenos">43 </span>        <span class="n">file1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="linenos">44 </span>
  <span class="linenos">45 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
  <span class="linenos">46 </span>    <span class="n">test</span><span class="p">()</span>
  </pre></div>
  </figure>
  <p>For testing I just have one text file with the file extension “.txt” on my Google Drive so my output from running this script looks like the following listing. I edited the output to change my file IDs and to only print a few lines of the debug printout of file titles.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python fetch_txt_files.py
  <span class="linenos"> 2 </span><span class="go">Your browser has been opened to visit:</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="go">    https://accounts.google.com/o/oauth2/auth?client_id=5\</span>
  <span class="linenos"> 5 </span><span class="go">29311921932-xsmj3hhiplr0dhqjln13fo4rrtvoslo8.apps.googleu</span>
  <span class="linenos"> 6 </span><span class="go">sercontent.com&amp;redirect_uri=http%3A%2F%2Flocalhost%3B6180</span>
  <span class="linenos"> 7 </span><span class="gp">%</span>2F<span class="p">&amp;</span><span class="nv">scope</span><span class="o">=</span>https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fdrive
  <span class="linenos"> 8 </span><span class="go">&amp;access_type=offline&amp;response_type=code</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="go">Authentication successful.</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="go">title: testdata, id: 1TZ9bnL5XYQvKACJw8VoKWdVJ8jeCszJ</span>
  <span class="linenos">13 </span><span class="go">title: sports.txt, id: 18RN4ojvURWt5yoKNtDdAJbh4fvmRpzwb</span>
  <span class="linenos">14 </span><span class="go">title: Anaconda blog article, id: 1kpLaYQA4Ao8ZbdFaXU209h\</span>
  <span class="linenos">15 </span><span class="go">g-z0tv1xA7YOQ4L8y8NbU</span>
  <span class="linenos">16 </span><span class="go">title: backups_2023, id: 1-k_r1HTfuZRWN7vwWWsYqfssl0C96J2x</span>
  <span class="linenos">17 </span><span class="go">title: Work notes, id: 1fDyHyZtKI-0oRNabA_P41LltYjGoek21</span>
  <span class="linenos">18 </span><span class="go">title: Sedona Writing Group Contact List, id: 1zK-5v9OQUf\</span>
  <span class="linenos">19 </span><span class="go">y8Sw33nTCl9vnL822hL1w</span>
  <span class="linenos">20 </span><span class="go"> ...</span>
  <span class="linenos">21 </span><span class="go">['sports.txt', '18RN4ojvURWt5yoKNtDdAJbh4fvmRpzwb', 'Spor\</span>
  <span class="linenos">22 </span><span class="go">t is generally recognised as activities based in physical</span>
  <span class="linenos">23 </span><span class="go"> athleticism or physical dexterity.[3] Sports are usually</span>
  <span class="linenos">24 </span><span class="go"> governed by rules to ensure fair competition and consist</span>
  <span class="linenos">25 </span><span class="go">ent adjudication of the winner.\n\n"Sport" comes from the</span>
  <span class="linenos">26 </span><span class="go"> Old French desport meaning "leisure", with the oldest de</span>
  <span class="linenos">27 </span><span class="go">finition in English from around 1300 being "anything huma</span>
  <span class="linenos">28 </span><span class="go">ns find amusing or entertaining".[4]\n\nOther bodies advo</span>
  <span class="linenos">29 </span><span class="go">cate widening the definition of sport to include all phys</span>
  <span class="linenos">30 </span><span class="go">ical activity and exercise. For instance, the Council of </span>
  <span class="linenos">31 </span><span class="go">Europe include all forms of physical exercise, including </span>
  <span class="linenos">32 </span><span class="go">those completed just for fun.\n\n']</span>
  </pre></div>
  </figure>
  <h2 id="generate-vector-indices-for-files-in-specific-google-drive-directories">Generate Vector Indices for Files in Specific Google Drive Directories</h2>
  <p>The example script in the last section should have created copies of the text files in you home Google Documents directory that end with “.txt”. Here, we use the same LlamaIndex test code that we used in a previous chapter. The test script <strong>index_and_QA.py</strong> is listed here:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="c1"># make sure you set the following environment variable is\</span>
  <span class="linenos"> 2 </span> <span class="nb">set</span><span class="p">:</span>
  <span class="linenos"> 3 </span><span class="c1">#   OPENAI_API_KEY</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">,</span> <span class="n">SimpleDirec</span>\
  <span class="linenos"> 6 </span><span class="n">toryReader</span>
  <span class="linenos"> 7 </span><span class="n">documents</span> <span class="o">=</span> <span class="n">SimpleDirectoryReader</span><span class="p">(</span><span class="s1">'data'</span><span class="p">)</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
  <span class="linenos"> 8 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTSimpleVectorIndex</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="c1"># save to disk</span>
  <span class="linenos">11 </span><span class="n">index</span><span class="o">.</span><span class="n">save_to_disk</span><span class="p">(</span><span class="s1">'index.json'</span><span class="p">)</span>
  <span class="linenos">12 </span><span class="c1"># load from disk</span>
  <span class="linenos">13 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTSimpleVectorIndex</span><span class="o">.</span><span class="n">load_from_disk</span><span class="p">(</span><span class="s1">'index.json'</span><span class="p">)</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="c1"># search for a document</span>
  <span class="linenos">16 </span><span class="nb">print</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"What is the definition of sport?"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>For my test file, the output looks like:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python index_and_QA.py 
  <span class="linenos"> 2 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [build_ind\</span>
  <span class="linenos"> 3 </span><span class="go">ex_from_documents] Total LLM token usage: 0 tokens</span>
  <span class="linenos"> 4 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [build_ind\</span>
  <span class="linenos"> 5 </span><span class="go">ex_from_documents] Total embedding token usage: 111 token</span>
  <span class="linenos"> 6 </span><span class="go">s</span>
  <span class="linenos"> 7 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [query] To\</span>
  <span class="linenos"> 8 </span><span class="go">tal LLM token usage: 202 tokens</span>
  <span class="linenos"> 9 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [query] To\</span>
  <span class="linenos">10 </span><span class="go">tal embedding token usage: 7 tokens</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="go">Sport is generally recognised as activities based in phys\</span>
  <span class="linenos">13 </span><span class="go">ical athleticism or physical dexterity that are governed </span>
  <span class="linenos">14 </span><span class="go">by rules to ensure fair competition and consistent adjudi</span>
  <span class="linenos">15 </span><span class="go">cation of the winner. It is anything humans find amusing </span>
  <span class="linenos">16 </span><span class="go">or entertaining, and can include all forms of physical ex</span>
  <span class="linenos">17 </span><span class="go">ercise, even those completed just for fun.</span>
  </pre></div>
  </figure>
  <p>It is interesting to see how the query result is rewritten in a nice form, compared to the raw text in the file <strong>sports.txt</strong> on my Google Drive:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>cat data/sports.txt 
  <span class="linenos"> 2 </span><span class="go">Sport is generally recognised as activities based in phys\</span>
  <span class="linenos"> 3 </span><span class="go">ical athleticism or physical dexterity.[3] Sports are usu</span>
  <span class="linenos"> 4 </span><span class="go">ally governed by rules to ensure fair competition and con</span>
  <span class="linenos"> 5 </span><span class="go">sistent adjudication of the winner.</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="go">"Sport" comes from the Old French desport meaning "leisur\</span>
  <span class="linenos"> 8 </span><span class="go">e", with the oldest definition in English from around 130</span>
  <span class="linenos"> 9 </span><span class="go">0 being "anything humans find amusing or entertaining".[4</span>
  <span class="linenos">10 </span><span class="go">]</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="go">Other bodies advocate widening the definition of sport to\</span>
  <span class="linenos">13 </span><span class="go"> include all physical activity and exercise. For instance</span>
  <span class="linenos">14 </span><span class="go">, the Council of Europe include all forms of physical exe</span>
  <span class="linenos">15 </span><span class="go">rcise, including those completed just for fun.</span>
  </pre></div>
  </figure>
  <h2 id="google-drive-example-wrap-up">Google Drive Example Wrap Up</h2>
  <p>If you already use Google Drive to store your working notes and other documents, then you might want to expand the simple example in this chapter to build your own query system for your documents. In addition to Google Drive, I also use Microsoft Office 365 and OneDrive in my work and personal projects.</p>
  <p>I haven’t written my own connectors yet for OneDrive but this is on my personal to-do list using the Microsoft library <a href="https://github.com/OneDrive/onedrive-sdk-python">https://github.com/OneDrive/onedrive-sdk-python</a>.</p>
  <h1 id="using-zapier-integrations-with-gmail-and-google-calendar">Using Zapier Integrations With GMail and Google Calendar</h1>
  <p>Zapier is a service for writing integrations with hundreds of cloud services. Here we will write some demos for writing automatic integrations with GMail and Google Calendar.</p>
  <p>Using the Zapier service is simple. You need to register the services you want to interact with on the Zapier developer web site and then you can express how you want to interact with services using natural language prompts.</p>
  <h2 id="set-up-development-environment">Set Up Development Environment</h2>
  <p>You will need a developer key for <a href="https://nla.zapier.com/get-started/">Zapier Natural Language Actions API</a>. Go to this linked web page and look for “Dev App” in the “Provider Name” column. If a key does not exist, you’ll need to set up an action to create a key. Click “Set up Actions” and follow the instructions. Your key will be in the Personal API Key column for the “Dev App.” Click to reveal and copy your key. You can <a href="https://nla.zapier.com/api/v1/dynamic/docs">read the documentation</a>.</p>
  <p>When I set up my Zapier account I set up three Zapier Natural Language Actions:</p>
  <ul>
  <li>Gmail: Fine Email</li>
  <li>Gmail: Send Email</li>
  <li>Google Calendar: Find Event</li>
  </ul>
  <p>If you do the same then you will see the Zapier registered actions:</p>
  <div class="figure-wrapper center"><figure class="image block" style="width: 144px"><img alt="" src="/site_images1/langchain/zapier1.png" style="width: 100%;"><figcaption></figcaption></figure></div>
  <h2 id="sending-a-test-gmail">Sending a Test GMail</h2>
  <p>In the following example replace <strong>TEST_EMAIL_ADDRESS</strong> with an email address that you can use for testing.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">initialize_agent</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">langchain.agents.agent_toolkits</span> <span class="kn">import</span> <span class="n">ZapierToolkit</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">langchain.utilities.zapier</span> <span class="kn">import</span> <span class="n">ZapierNLAWrapper</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="linenos"> 7 </span><span class="n">zapier</span> <span class="o">=</span> <span class="n">ZapierNLAWrapper</span><span class="p">()</span>
  <span class="linenos"> 8 </span><span class="n">toolkit</span> <span class="o">=</span> <span class="n">ZapierToolkit</span><span class="o">.</span><span class="n">from_zapier_nla_wrapper</span><span class="p">(</span><span class="n">zapier</span><span class="p">)</span>
  <span class="linenos"> 9 </span><span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(),</span> <span class="n">llm</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span>\
  <span class="linenos">10 </span><span class="s2">"zero-shot-react-description"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"Send an Email to TEST_EMAIL_ADDRESS via gmail </span><span class="se">\</span>
  <span class="linenos">13 </span><span class="s2">that is a pitch for hiring Mark Watson as a consultant fo</span>
  <span class="linenos">14 </span><span class="n">r</span> <span class="n">deep</span> <span class="n">learning</span> <span class="ow">and</span> <span class="n">large</span> <span class="n">language</span> <span class="n">models</span><span class="s2">")</span>
  </pre></div>
  </figure>
  <p>Here is the sample output:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python send_gmail.py
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="go">&gt; Entering new AgentExecutor chain...</span>
  <span class="linenos"> 5 </span><span class="go"> I need to use the Gmail: Send Email tool</span>
  <span class="linenos"> 6 </span><span class="go">Action: Gmail: Send Email</span>
  <span class="linenos"> 7 </span><span class="go">Action Input: Send an email to TEST_EMAIL_ADDRESS with th\</span>
  <span class="linenos"> 8 </span><span class="go">e subject "Pitch for Hiring Mark Watson as a Consultant f</span>
  <span class="linenos"> 9 </span><span class="go">or Deep Learning and Large Language Models" and the body </span>
  <span class="linenos">10 </span><span class="go">"Dear Mark Watson, I am writing to you to pitch the idea </span>
  <span class="linenos">11 </span><span class="go">of hiring you as a consultant for deep learning and large</span>
  <span class="linenos">12 </span><span class="go"> language models. I believe you have the expertise and ex</span>
  <span class="linenos">13 </span><span class="go">perience to help us achieve our goals. Please let me know</span>
  <span class="linenos">14 </span><span class="go"> if you are interested in discussing further. Thank you f</span>
  <span class="linenos">15 </span><span class="go">or your time."</span>
  <span class="linenos">16 </span><span class="go">Cc: not enough information provided in the instruction, m\</span>
  <span class="linenos">17 </span><span class="go">issing Cc</span>
  <span class="linenos">18 </span><span class="go">Observation: {"labelIds": "SENT"}</span>
  <span class="linenos">19 </span><span class="go">Thought: I now know the final answer</span>
  <span class="linenos">20 </span><span class="go">Final Answer: An email has been sent to TEST_EMAIL_ADDRES\</span>
  <span class="linenos">21 </span><span class="go">S with the subject "Pitch for Hiring Mark Watson as a Con</span>
  <span class="linenos">22 </span><span class="go">sultant for Deep Learning and Large Language Models" and </span>
  <span class="linenos">23 </span><span class="go">the body "Dear Mark Watson, I am writing to you to pitch </span>
  <span class="linenos">24 </span><span class="go">the idea of hiring you as a consultant for deep learning </span>
  <span class="linenos">25 </span><span class="go">and large language models. I believe you have the experti</span>
  <span class="linenos">26 </span><span class="go">se and experience to help us achieve our goals. Please le</span>
  <span class="linenos">27 </span><span class="go">t me know if you are interested in discussing further. Th</span>
  <span class="linenos">28 </span><span class="go">ank you for your time."</span>
  <span class="linenos">29 </span>
  <span class="linenos">30 </span><span class="go">&gt; Finished chain.</span>
  </pre></div>
  </figure>
  <h2 id="google-calendar-integration-example">Google Calendar Integration Example</h2>
  <p>Assuming that you configured the Zapier Natural Language Action “Google Calendar: Find Event” then the same code we used to send an email in the last section works for checking calendar entries, you just need to change the natural language prompt:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">initialize_agent</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">langchain.agents.agent_toolkits</span> <span class="kn">import</span> <span class="n">ZapierToolkit</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">langchain.utilities.zapier</span> <span class="kn">import</span> <span class="n">ZapierNLAWrapper</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="linenos"> 7 </span><span class="n">zapier</span> <span class="o">=</span> <span class="n">ZapierNLAWrapper</span><span class="p">()</span>
  <span class="linenos"> 8 </span><span class="n">toolkit</span> <span class="o">=</span> <span class="n">ZapierToolkit</span><span class="o">.</span><span class="n">from_zapier_nla_wrapper</span><span class="p">(</span><span class="n">zapier</span><span class="p">)</span>
  <span class="linenos"> 9 </span><span class="n">agent</span> <span class="o">=</span> <span class="n">initialize_agent</span><span class="p">(</span><span class="n">toolkit</span><span class="o">.</span><span class="n">get_tools</span><span class="p">(),</span> <span class="n">llm</span><span class="p">,</span> 
  <span class="linenos">10 </span>                         <span class="n">agent</span><span class="o">=</span><span class="s2">"zero-shot-react-descripti</span><span class="se">\</span>
  <span class="linenos">11 </span><span class="s2">on"</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="linenos">12 </span>
  <span class="linenos">13 </span><span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"Get my Google Calendar entries for tomorrow"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>And the output looks like:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python get_google_calendar.py
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="go">&gt; Entering new AgentExecutor chain...</span>
  <span class="linenos"> 4 </span><span class="go"> I need to find events in my Google Calendar</span>
  <span class="linenos"> 5 </span><span class="go">Action: Google Calendar: Find Event</span>
  <span class="linenos"> 6 </span><span class="go">Action Input: Find events in my Google Calendar tomorrow</span>
  <span class="linenos"> 7 </span><span class="go">Observation: {"location": "Greg to call Mark on (928) XXX\</span>
  <span class="linenos"> 8 </span><span class="go">-ZZZZ", "kind": "calendar#event", "end__dateTime": "2023-</span>
  <span class="linenos"> 9 </span><span class="go">03-23T10:00:00-07:00", "status": "confirmed", "end__dateT</span>
  <span class="linenos">10 </span><span class="go">ime_pretty": "Mar 23, 2023 10:00AM", "htmlLink": "https:/</span>
  <span class="linenos">11 </span><span class="go">/zpr.io/WWWWWWWW"}</span>
  <span class="linenos">12 </span><span class="go">Thought: I now know the final answer</span>
  <span class="linenos">13 </span><span class="go">Final Answer: I have an event in my Google Calendar tomor\</span>
  <span class="linenos">14 </span><span class="go">row at 10:00AM.</span>
  <span class="linenos">15 </span>
  <span class="linenos">16 </span><span class="go">&gt; Finished chain.</span>
  </pre></div>
  </figure>
  <p>I edited this output to remove some private information.</p>
  <h1 id="natural-language-sqlite-database-queries-with-langchain">Natural Language SqLite Database Queries With LangChain</h1>
  <p>The LangChain library support fof SqLite databases uses the Python library SQLAlchemy for database connections. This abstraction layer allows LangChain to use the same logic and models for other relational databases.</p>
  <p>I have a long work history of writing natural language interfaces for relational databases that I will review in the chapter wrap up. For now, I invite you to be amazed at how simple it is to write the LangChain scripts for querying a database in natural language.</p>
  <p>We will use the SQlite sample database from the SQLite Tutorial web site:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span>https://www.sqlitetutorial.net/sqlite-sample-database/
  </pre></div>
  </figure>
  <p>This database has 11 tables. The above URI has documentatiuon for this database so please take a minute to review the <a href="https://www.sqlitetutorial.net/sqlite-sample-database/">table schema diagram and text description</a>.</p>
  <p>This example is derived from the <a href="https://langchain.readthedocs.io/en/latest/modules/chains/examples/sqlite.html">LangChain documentation</a>. We use three classes from the langchain library:</p>
  <ul>
  <li>OpenAI: A class that represents the OpenAI language model, which is capable of understanding natural language and generating a response.</li>
  <li>SQLDatabase: A class that represents a connection to an SQL database.</li>
  <li>SQLDatabaseChain: A class that connects the OpenAI language model with the SQL database to allow natural language querying.</li>
  </ul>
  <p>The temperature parameter set to 0 in this example. The temperature parameter controls the randomness of the generated output. A lower value (like 0) makes the model’s output more deterministic and focused, while a higher value introduces more randomness (or “creativity”). The run method of the db_chain object translates the natural language query into an appropriate SQL query, execute it on the connected database, and then returns the result converting the output into natural language.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="c1"># SqLite NLP Query Demo Script</span>
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">SQLDatabase</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">SQLDatabaseChain</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="n">db</span> <span class="o">=</span> <span class="n">SQLDatabase</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="s2">"sqlite:///chinook.db"</span><span class="p">)</span>
  <span class="linenos"> 7 </span><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="n">db_chain</span> <span class="o">=</span> <span class="n">SQLDatabaseChain</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">verbose</span>\
  <span class="linenos">10 </span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="n">db_chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"How many employees are there?"</span><span class="p">)</span>
  <span class="linenos">13 </span><span class="n">db_chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"What is the name of the first employee?"</span><span class="p">)</span>
  <span class="linenos">14 </span><span class="n">db_chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"Which customer has the most invoices?"</span><span class="p">)</span>
  <span class="linenos">15 </span><span class="n">db_chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"List all music genres in the database"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>The output (edited for brevity) shows the generated SQL queries and the query results:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python sqlite_chat_test.py
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="go">&gt; Entering new SQLDatabaseChain chain...</span>
  <span class="linenos"> 4 </span><span class="go">How many employees are there? </span>
  <span class="linenos"> 5 </span><span class="go"> SELECT COUNT(*) FROM employees;</span>
  <span class="linenos"> 6 </span><span class="go">SQLResult: [(8,)]</span>
  <span class="linenos"> 7 </span><span class="go">Answer: There are 8 employees.</span>
  <span class="linenos"> 8 </span><span class="go">&gt; Finished chain.</span>
  <span class="linenos"> 9 </span>
  <span class="linenos">10 </span><span class="go">&gt; Entering new SQLDatabaseChain chain...</span>
  <span class="linenos">11 </span><span class="go">What is the name of the first employee? </span>
  <span class="linenos">12 </span><span class="go"> SELECT FirstName, LastName FROM employees WHERE Employee\</span>
  <span class="linenos">13 </span><span class="go">Id = 1;</span>
  <span class="linenos">14 </span><span class="go">SQLResult: [('Andrew', 'Adams')]</span>
  <span class="linenos">15 </span><span class="go">Answer: The first employee is Andrew Adams.</span>
  <span class="linenos">16 </span><span class="go">&gt; Finished chain.</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="go">&gt; Entering new SQLDatabaseChain chain...</span>
  <span class="linenos">19 </span><span class="go">Which customer has the most invoices? </span>
  <span class="linenos">20 </span><span class="go"> SELECT customers.FirstName, customers.LastName, COUNT(in\</span>
  <span class="linenos">21 </span><span class="go">voices.InvoiceId) AS NumberOfInvoices FROM customers INNE</span>
  <span class="linenos">22 </span><span class="go">R JOIN invoices ON customers.CustomerId = invoices.Custom</span>
  <span class="linenos">23 </span><span class="go">erId GROUP BY customers.CustomerId ORDER BY NumberOfInvoi</span>
  <span class="linenos">24 </span><span class="go">ces DESC LIMIT 5;</span>
  <span class="linenos">25 </span><span class="go">SQLResult: [('Luis', 'Goncalves', 7), ('Leonie', 'Kohler'\</span>
  <span class="linenos">26 </span><span class="go">, 7), ('Francois', 'Tremblay', 7), ('Bjorn', 'Hansen', 7)</span>
  <span class="linenos">27 </span><span class="go">, ('Frantisek', 'Wichterlova', 7)]</span>
  <span class="linenos">28 </span><span class="go">Answer: Luis Goncalves has the most invoices with 7.</span>
  <span class="linenos">29 </span><span class="go">&gt; Finished chain.</span>
  <span class="linenos">30 </span>
  <span class="linenos">31 </span><span class="go">&gt; Entering new SQLDatabaseChain chain...</span>
  <span class="linenos">32 </span><span class="go">List all music genres in the database </span>
  <span class="linenos">33 </span><span class="go">SQLQuery: SELECT Name FROM genres</span>
  <span class="linenos">34 </span><span class="go">SQLResult: [('Rock',), ('Jazz',), ('Metal',), ('Alternati\</span>
  <span class="linenos">35 </span><span class="go">ve &amp; Punk',), ('Rock And Roll',), ('Blues',), ('Latin',),</span>
  <span class="linenos">36 </span><span class="go"> ('Reggae',), ('Pop',), ('Soundtrack',), ('Bossa Nova',),</span>
  <span class="linenos">37 </span><span class="go"> ('Easy Listening',), ('Heavy Metal',), ('R&amp;B/Soul',), ('</span>
  <span class="linenos">38 </span><span class="go">Electronica/Dance',), ('World',), ('Hip Hop/Rap',), ('Sci</span>
  <span class="linenos">39 </span><span class="go">ence Fiction',), ('TV Shows',), ('Sci Fi &amp; Fantasy',), ('</span>
  <span class="linenos">40 </span><span class="go">Drama',), ('Comedy',), ('Alternative',), ('Classical',), </span>
  <span class="linenos">41 </span><span class="gp gp-VirtualEnv">('Opera',)</span><span class="go">]</span>
  <span class="linenos">42 </span><span class="go">Answer: Rock, Jazz, Metal, Alternative &amp; Punk, Rock And R\</span>
  <span class="linenos">43 </span><span class="go">oll, Blues, Latin, Reggae, Pop, Soundtrack, Bossa Nova, E</span>
  <span class="linenos">44 </span><span class="go">asy Listening, Heavy Metal, R&amp;B/Soul, Electronica/Dance, </span>
  <span class="linenos">45 </span><span class="go">World, Hip Hop/Rap, Science Fiction, TV Shows, Sci Fi &amp; F</span>
  <span class="linenos">46 </span><span class="go">antasy, Drama, Comedy, Alternative, Classical, Opera</span>
  <span class="linenos">47 </span><span class="go">&gt; Finished chain.</span>
  </pre></div>
  </figure>
  <h2 id="natural-language-database-query-wrap-up">Natural Language Database Query Wrap Up</h2>
  <p>I had an example I wrote for the first two editions of my <a href="https://leanpub.com/javaai">Java AI book</a> (I later removed this example because the code was too long and too difficult to follow). I later reworked this example in Common Lisp and used both versions in several consulting projects in the late 1990s and early 2000s.</p>
  <p>The last book I wrote <a href="https://leanpub.com/pythonai">Practical Python Artificial Intelligence Programming</a> used an OpenAI example <a href="https://github.com/openai/openai-cookbook/blob/main/examples/Backtranslation_of_SQL_queries.py">https://github.com/openai/openai-cookbook/blob/main/examples/Backtranslation_of_SQL_queries.py</a> that relatively simnple code (relative to my older hand-written Java and Common Lisp code) for a NLP database interface.</p>
  <p>Compared to the elegant support for NLP database queries in LangChain, the previous examples have limited power and required a lot more code. As I write this in March 2023, it is a good feeling that for the rest of my career, NLP database access is now a solved problem!</p>
  <h1 id="examples-using-hugging-face-open-source-models">Examples Using Hugging Face Open Source Models</h1>
  <p>To start with you will need to create a free account on the <a href="https://huggingface.co/docs/huggingface_hub/index">Hugging Face Hub</a> and get an API key and install:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span>pip install --upgrade huggingface_hub
  </pre></div>
  </figure>
  <p>You need to set the foillowing environment variable to your Hugging Face Hub access token:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span>HUGGINGFACEHUB_API_TOKEN
  </pre></div>
  </figure>
  <p>So far in this book we have been using the OpenAI LLM wrapper:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span><span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>
  </pre></div>
  </figure>
  <p>Here we will use the alternative Hugging Face wrapper class:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos">1 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">HuggingFaceHub</span>
  </pre></div>
  </figure>
  <p>The LangChain library hides most of the details of using both APIs. This is a really good thing. I have had a few discussions on social tech media with people who object to the non open source nature of OpenAI. While I like the convenience of using OpenAI’s APIs, I always like to have alternatives for proprietary technology I use.</p>
  <p>The Hugging Face Hub endpoint in LangChain connects to the Hugging Face Hub and runs the models via their free inference endpoints. We need a Hugging Face account and API key to use these endpoints3. There exists two Hugging Face LLM wrappers, one for a local pipeline and one for a model hosted on Hugging Face Hub. Note that these wrappers only work for models that support the text2text-generation and text-generation tasks. Text2text-generation refers to the task of generating a text sequence from another text sequence. For example, generating a summary of a long article. Text-generation refers to the task of generating a text sequence from scratch.</p>
  <h2 id="using-langchain-as-a-wrapper-for-hugging-face-prediction-model-apis">Using LangChain as a Wrapper for Hugging Face Prediction Model APIs</h2>
  <p>We will start with a simple example using the prompt text support in LangChain. The following example is in the script <strong>simple_example.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">HuggingFaceHub</span><span class="p">,</span> <span class="n">LLMChain</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="n">hub_llm</span> <span class="o">=</span> <span class="n">HuggingFaceHub</span><span class="p">(</span>
  <span class="linenos"> 5 </span>    <span class="n">repo_id</span><span class="o">=</span><span class="s1">'google/flan-t5-xl'</span><span class="p">,</span>
  <span class="linenos"> 6 </span>    <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'temperature'</span><span class="p">:</span><span class="mf">1e-6</span><span class="p">}</span>
  <span class="linenos"> 7 </span><span class="p">)</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
  <span class="linenos">10 </span>    <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">"name"</span><span class="p">],</span>
  <span class="linenos">11 </span>    <span class="n">template</span><span class="o">=</span><span class="s2">"What year did </span><span class="si">{name}</span><span class="s2"> get elected as preside</span><span class="se">\</span>
  <span class="linenos">12 </span><span class="s2">nt?"</span><span class="p">,</span>
  <span class="linenos">13 </span><span class="p">)</span>
  <span class="linenos">14 </span>
  <span class="linenos">15 </span><span class="n">llm_chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">hub_llm</span><span class="p">)</span>
  <span class="linenos">16 </span>
  <span class="linenos">17 </span><span class="nb">print</span><span class="p">(</span><span class="n">llm_chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"George Bush"</span><span class="p">))</span>
  </pre></div>
  </figure>
  <p>By changing just a few lines of code, you can run many of the examples in this book using the Hugging Face APIs in place of the OpenAI APIs.</p>
  <p>The LangChain documentation lists the source code for a wrapper to use local Hugging Face embeddings <a href="https://langchain.readthedocs.io/en/latest/_modules/langchain/embeddings/self_hosted_hugging_face.html">here</a>.</p>
  <h2 id="creating-a-custom-llamaindex-hugging-face-llm-wrapper-class-that-runs-on-your-laptop">Creating a Custom LlamaIndex Hugging Face LLM Wrapper Class That Runs on Your Laptop</h2>
  <p>We will be downloading the Hugging Face model <strong>facebook/opt-iml-1.3b</strong> that is a 2.6 gigabyte file. This model is downloaded the first time it is requested and is then cached in <strong>~/.cache/huggingface/hub</strong> for later reuse.</p>
  <p>This example is modified from an example for custom LLMs in the <a href="https://gpt-index.readthedocs.io/en/latest/how_to/custom_llms.html">LlamaIndex documentation</a>. Note that I have used a much smaller model in this example and reduced the prompt and output text size.</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="c1"># Derived from example:</span>
  <span class="linenos"> 2 </span><span class="c1">#   https://gpt-index.readthedocs.io/en/latest/how_to/cus\</span>
  <span class="linenos"> 3 </span><span class="n">tom_llms</span><span class="o">.</span><span class="n">html</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="kn">import</span> <span class="nn">time</span>
  <span class="linenos"> 6 </span><span class="kn">import</span> <span class="nn">torch</span>
  <span class="linenos"> 7 </span><span class="kn">from</span> <span class="nn">langchain.llms.base</span> <span class="kn">import</span> <span class="n">LLM</span>
  <span class="linenos"> 8 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">SimpleDirectoryReader</span><span class="p">,</span> <span class="n">LangchainE</span>\
  <span class="linenos"> 9 </span><span class="n">mbedding</span>
  <span class="linenos">10 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">GPTListIndex</span><span class="p">,</span> <span class="n">PromptHelper</span>
  <span class="linenos">11 </span><span class="kn">from</span> <span class="nn">llama_index</span> <span class="kn">import</span> <span class="n">LLMPredictor</span>
  <span class="linenos">12 </span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span><span class="n">max_input_size</span> <span class="o">=</span> <span class="mi">512</span>
  <span class="linenos">15 </span><span class="n">num_output</span> <span class="o">=</span> <span class="mi">64</span>
  <span class="linenos">16 </span><span class="n">max_chunk_overlap</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="linenos">17 </span><span class="n">prompt_helper</span> <span class="o">=</span> <span class="n">PromptHelper</span><span class="p">(</span><span class="n">max_input_size</span><span class="p">,</span> <span class="n">num_output</span><span class="p">,</span> \
  <span class="linenos">18 </span><span class="n">max_chunk_overlap</span><span class="p">)</span>
  <span class="linenos">19 </span>
  <span class="linenos">20 </span><span class="k">class</span> <span class="nc">CustomLLM</span><span class="p">(</span><span class="n">LLM</span><span class="p">):</span>
  <span class="linenos">21 </span>    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">"facebook/opt-iml-1.3b"</span>
  <span class="linenos">22 </span>    <span class="c1"># I am not using a GPU, but you can add device="cuda:\</span>
  <span class="linenos">23 </span><span class="mi">0</span><span class="s2">"</span>
  <span class="linenos">24 </span>    <span class="c1"># to the pipeline call if you have a local GPU or</span>
  <span class="linenos">25 </span>    <span class="c1"># are running this on Google Colab:</span>
  <span class="linenos">26 </span>    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s2">"text-generation"</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_na</span>\
  <span class="linenos">27 </span><span class="n">me</span><span class="p">,</span>
  <span class="linenos">28 </span>                        <span class="n">model_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"torch_dtype"</span><span class="p">:</span><span class="n">torch</span>\
  <span class="linenos">29 </span><span class="o">.</span><span class="n">bfloat16</span><span class="p">})</span>
  <span class="linenos">30 </span>
  <span class="linenos">31 </span>    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="linenos">32 </span>        <span class="n">prompt_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
  <span class="linenos">33 </span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">max_new_tokens</span><span class="o">=</span><span class="n">n</span>\
  <span class="linenos">34 </span><span class="n">um_output</span><span class="p">)</span>
  <span class="linenos">35 </span>        <span class="n">first_response</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">"generated_text"</span><span class="p">]</span>
  <span class="linenos">36 </span>        <span class="c1"># only return newly generated tokens</span>
  <span class="linenos">37 </span>        <span class="n">returned_text</span> <span class="o">=</span> <span class="n">first_response</span><span class="p">[</span><span class="n">prompt_length</span><span class="p">:]</span>
  <span class="linenos">38 </span>        <span class="k">return</span> <span class="n">returned_text</span>
  <span class="linenos">39 </span>
  <span class="linenos">40 </span>    <span class="nd">@property</span>
  <span class="linenos">41 </span>    <span class="k">def</span> <span class="nf">_identifying_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="linenos">42 </span>        <span class="k">return</span> <span class="p">{</span><span class="s2">"name_of_model"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">}</span>
  <span class="linenos">43 </span>
  <span class="linenos">44 </span>    <span class="nd">@property</span>
  <span class="linenos">45 </span>    <span class="k">def</span> <span class="nf">_llm_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="linenos">46 </span>        <span class="k">return</span> <span class="s2">"custom"</span>
  <span class="linenos">47 </span>
  <span class="linenos">48 </span><span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="linenos">49 </span>
  <span class="linenos">50 </span><span class="c1"># define our LLM</span>
  <span class="linenos">51 </span><span class="n">llm_predictor</span> <span class="o">=</span> <span class="n">LLMPredictor</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">CustomLLM</span><span class="p">())</span>
  <span class="linenos">52 </span>
  <span class="linenos">53 </span><span class="c1"># Load the your data</span>
  <span class="linenos">54 </span><span class="n">documents</span> <span class="o">=</span> <span class="n">SimpleDirectoryReader</span><span class="p">(</span><span class="s1">'../data_small'</span><span class="p">)</span><span class="o">.</span><span class="n">load_d</span>\
  <span class="linenos">55 </span><span class="n">ata</span><span class="p">()</span>
  <span class="linenos">56 </span><span class="n">index</span> <span class="o">=</span> <span class="n">GPTListIndex</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">llm_predictor</span><span class="o">=</span><span class="n">llm_predict</span>\
  <span class="linenos">57 </span><span class="ow">or</span><span class="p">,</span>
  <span class="linenos">58 </span>                     <span class="n">prompt_helper</span><span class="o">=</span><span class="n">prompt_helper</span><span class="p">)</span>
  <span class="linenos">59 </span>
  <span class="linenos">60 </span><span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="linenos">61 </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time to load model from disk: </span><span class="si">{</span><span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span><span class="si">}</span><span class="s2"> sec</span><span class="se">\</span>
  <span class="linenos">62 </span><span class="s2">onds."</span><span class="p">)</span>
  <span class="linenos">63 </span>
  <span class="linenos">64 </span><span class="c1"># Query and print response</span>
  <span class="linenos">65 </span><span class="n">response</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"What is the definition of sport?"</span><span class="p">)</span>
  <span class="linenos">66 </span><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="linenos">67 </span>
  <span class="linenos">68 </span><span class="n">time3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  <span class="linenos">69 </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Time for query/prediction: </span><span class="si">{</span><span class="n">time3</span> <span class="o">-</span> <span class="n">time2</span><span class="si">}</span><span class="s2"> second</span><span class="se">\</span>
  <span class="linenos">70 </span><span class="s2">s."</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>When running on my M1 MacBook Pro using only the CPU (no GPU or Neural Engine configuration) we can read the model from disk quickly but it takes a while to process queries:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python hf_transformer_local.py
  <span class="linenos"> 2 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [build_ind\</span>
  <span class="linenos"> 3 </span><span class="go">ex_from_documents] Total LLM token usage: 0 tokens</span>
  <span class="linenos"> 4 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [build_ind\</span>
  <span class="linenos"> 5 </span><span class="go">ex_from_documents] Total embedding token usage: 0 tokens</span>
  <span class="linenos"> 6 </span><span class="go">Time to load model from disk: 1.5303528308868408 seconds.</span>
  <span class="linenos"> 7 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [query] To\</span>
  <span class="linenos"> 8 </span><span class="go">tal LLM token usage: 182 tokens</span>
  <span class="linenos"> 9 </span><span class="go">INFO:llama_index.token_counter.token_counter:&gt; [query] To\</span>
  <span class="linenos">10 </span><span class="go">tal embedding token usage: 0 tokens</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="go">"Sport" comes from the Old French desport meaning "leisur\</span>
  <span class="linenos">13 </span><span class="go">e", with the oldest definition in English from around 130</span>
  <span class="linenos">14 </span><span class="go">0 being "anything humans find amusing or entertaining".[4</span>
  <span class="linenos">15 </span><span class="go">]</span>
  <span class="linenos">16 </span><span class="go">Time for query/prediction: 228.8184850215912 seconds.</span>
  </pre></div>
  </figure>
  <p>Even though my M1 MacBook does fairly well when I configure TensorFlow and PyTorch to use the Apple Silicon GPUs and Neural Engines, I usually do my model development using Google Colab.</p>
  <p>Let’s rerun the last example on Colab:</p>
  <div class="figure-wrapper center"><figure class="image block" style="width: 144px"><img alt="" src="/site_images1/langchain/local.png" style="width: 100%;"><figcaption></figcaption></figure></div>
  <p>Using a a standard Colab GPU, the query/prediction time is much faster. Here is a <a href="https://colab.research.google.com/drive/1Ecg-0iid3AD05zM4HgPXTVHcgkGxyi3q?usp=sharing">link to my Colab notebook</a> if you would prefer to run this example on Colab instead of on your laptop.</p>
  <h1 id="using-large-language-models-to-write-recipes">Using Large Language Models to Write Recipes</h1>
  <p>If you ask the ChatGPT web app to write a recipe using a user supplied ingredient list and a description it does a fairly good job at generating recipes. For the example in this chapter I am taking a different approach:</p>
  <ul>
  <li>Use the recipe and ingredient files from my web app <a href="http://cookingspace.com">http://cookingspace.com</a> to create context text, given a user prompt for a recipe.</li>
  <li>Treat this as a text prediction problem.</li>
  <li>Format the response for display.</li>
  </ul>
  <p>This approach has an advantage (for me!) that the generated recipes will be more similar to the recipes I enjoy cooking since the context data will be derived from my own recipe files.</p>
  <h2 id="preparing-recipe-data">Preparing Recipe Data</h2>
  <p>I am using the JSON Recipe files from my web app <a href="http://cookingspace.com">http://cookingspace.com</a>. The following Python script converts my JSON data to text descriptions, one per file:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">import</span> <span class="nn">json</span>
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="k">def</span> <span class="nf">process_json</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
  <span class="linenos"> 4 </span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="linenos"> 5 </span>        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span>    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
  <span class="linenos"> 8 </span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">"text_data/</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">.txt"</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="linenos"> 9 </span>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Recipe name: "</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
  <span class="linenos">10 </span>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Number of servings: "</span> <span class="o">+</span>
  <span class="linenos">11 </span>                    <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'num_served'</span><span class="p">])</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
  <span class="linenos">12 </span>            <span class="n">ingrediants</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"  "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="s1">'amount'</span><span class="p">])</span> <span class="o">+</span>
  <span class="linenos">13 </span>                           <span class="s1">' '</span> <span class="o">+</span> <span class="n">ii</span><span class="p">[</span><span class="s1">'units'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span>
  <span class="linenos">14 </span>                           <span class="n">ii</span><span class="p">[</span><span class="s1">'description'</span><span class="p">]</span>
  <span class="linenos">15 </span>                           <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">'ingredients'</span><span class="p">]]</span>
  <span class="linenos">16 </span>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Ingredients:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>
  <span class="linenos">17 </span>                    <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ingrediants</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n\n</span><span class="s1">'</span><span class="p">)</span>
  <span class="linenos">18 </span>            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Directions: "</span> <span class="o">+</span>
  <span class="linenos">19 </span>                    <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">'directions'</span><span class="p">])</span> <span class="o">+</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
  <span class="linenos">20 </span>
  <span class="linenos">21 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
  <span class="linenos">22 </span>    <span class="n">process_json</span><span class="p">(</span><span class="s1">'data/vegetarian.json'</span><span class="p">)</span>
  <span class="linenos">23 </span>    <span class="n">process_json</span><span class="p">(</span><span class="s1">'data/desert.json'</span><span class="p">)</span>
  <span class="linenos">24 </span>    <span class="n">process_json</span><span class="p">(</span><span class="s1">'data/fish.json'</span><span class="p">)</span>
  <span class="linenos">25 </span>    <span class="n">process_json</span><span class="p">(</span><span class="s1">'data/meat.json'</span><span class="p">)</span>
  <span class="linenos">26 </span>    <span class="n">process_json</span><span class="p">(</span><span class="s1">'data/misc.json'</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>Here is a listing of one of the shorter generated recipe files (i.e., text recipe data converted from raw JSON recipe data from my CookingSpace.com web site):</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="go">Recipe name: Black Bean Dip</span>
  <span class="linenos"> 2 </span>
  <span class="linenos"> 3 </span><span class="go">Number of servings: 6</span>
  <span class="linenos"> 4 </span>
  <span class="linenos"> 5 </span><span class="go">Ingredients:</span>
  <span class="linenos"> 6 </span><span class="go">  2 cup Refried Black Beans</span>
  <span class="linenos"> 7 </span><span class="go">  1/4 cup Sour cream</span>
  <span class="linenos"> 8 </span><span class="go">  1 teaspoon Ground cumin</span>
  <span class="linenos"> 9 </span><span class="go">  1/2 cup Salsa</span>
  <span class="linenos">10 </span>
  <span class="linenos">11 </span><span class="go">Directions: Use either a food processor or a mixing bowl \</span>
  <span class="linenos">12 </span><span class="go">and hand mixer to make this appetizer. Blend the black be</span>
  <span class="linenos">13 </span><span class="go">ans and cumin for at least one minute until the mixture i</span>
  <span class="linenos">14 </span><span class="go">s fairly smooth. Stir in salsa and sour cream and lightly</span>
  <span class="linenos">15 </span><span class="go"> mix. Serve immediately or store in the refrigerator.</span>
  </pre></div>
  </figure>
  <p>I have generated 41 individual recipe files that will be used for the remainder of this chapter.</p>
  <p>In the next section when we use a LLM to generate a recipe, the directions are numbered steps and the formatting is different than my original recipe document files.</p>
  <h2 id="a-prediction-model-using-the-openai-text-davinci-002-model">A Prediction Model Using the OpenAI text-davinci-002 Model</h2>
  <p>Here we use the <strong>DirectoryLoader</strong> class that we have used in previous examples to load and then create an embedding index.</p>
  <p>Here is the listing for the script <strong>recipe_generator.py</strong>:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="kn">from</span> <span class="nn">langchain.text_splitter</span> <span class="kn">import</span> <span class="n">CharacterTextSplitter</span>
  <span class="linenos"> 2 </span><span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">Chroma</span>
  <span class="linenos"> 3 </span><span class="kn">from</span> <span class="nn">langchain.embeddings</span> <span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
  <span class="linenos"> 4 </span><span class="kn">from</span> <span class="nn">langchain.document_loaders</span> <span class="kn">import</span> <span class="n">DirectoryLoader</span>
  <span class="linenos"> 5 </span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">VectorDBQA</span>
  <span class="linenos"> 6 </span>
  <span class="linenos"> 7 </span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">OpenAIEmbeddings</span><span class="p">()</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="n">loader</span> <span class="o">=</span> <span class="n">DirectoryLoader</span><span class="p">(</span><span class="s1">'./text_data/'</span><span class="p">,</span> <span class="n">glob</span><span class="o">=</span><span class="s2">"**/*.txt"</span><span class="p">)</span>
  <span class="linenos">10 </span><span class="n">documents</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
  <span class="linenos">11 </span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">CharacterTextSplitter</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span>
  <span class="linenos">12 </span>                                      <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="linenos">13 </span>
  <span class="linenos">14 </span><span class="n">texts</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_documents</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span>
  <span class="linenos">15 </span>
  <span class="linenos">16 </span><span class="n">docsearch</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="n">qa</span> <span class="o">=</span> <span class="n">VectorDBQA</span><span class="o">.</span><span class="n">from_chain_type</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="linenos">19 </span>                                <span class="n">model_name</span><span class="o">=</span>
  <span class="linenos">20 </span>                                <span class="s2">"text-davinci-002"</span><span class="p">),</span>
  <span class="linenos">21 </span>                                <span class="n">chain_type</span><span class="o">=</span><span class="s2">"stuff"</span><span class="p">,</span>
  <span class="linenos">22 </span>                                <span class="n">vectorstore</span><span class="o">=</span><span class="n">docsearch</span><span class="p">)</span>
  <span class="linenos">23 </span>
  <span class="linenos">24 </span><span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
  <span class="linenos">25 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">Recipe creation request: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">26 </span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">qa</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="linenos">27 </span>
  <span class="linenos">28 </span><span class="n">query</span><span class="p">(</span><span class="s2">"Create a new recipe using Broccoli and Chicken"</span><span class="p">)</span>
  <span class="linenos">29 </span><span class="n">query</span><span class="p">(</span><span class="s2">"Create a recipe using Beans, Rice, and Chicken"</span><span class="p">)</span>
  </pre></div>
  </figure>
  <p>This generated two recipes. Here is the output for the first request:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="gp">$ </span>python recipe_generator.py
  <span class="linenos"> 2 </span><span class="go">Running Chroma using direct local API.</span>
  <span class="linenos"> 3 </span><span class="go">Using DuckDB in-memory for database. Data will be transie\</span>
  <span class="linenos"> 4 </span><span class="go">nt.</span>
  <span class="linenos"> 5 </span>
  <span class="linenos"> 6 </span><span class="go">Recipe creation request: Create a new recipe using both B\</span>
  <span class="linenos"> 7 </span><span class="go">roccoli and Chicken</span>
  <span class="linenos"> 8 </span>
  <span class="linenos"> 9 </span><span class="go">Recipe name: Broccoli and Chicken Teriyaki</span>
  <span class="linenos">10 </span><span class="go">Number of servings: 4</span>
  <span class="linenos">11 </span>
  <span class="linenos">12 </span><span class="go">Ingredients:</span>
  <span class="linenos">13 </span><span class="go">1 cup broccoli</span>
  <span class="linenos">14 </span><span class="go">1 pound chicken meat</span>
  <span class="linenos">15 </span><span class="go">2 tablespoons soy sauce</span>
  <span class="linenos">16 </span><span class="go">1 tablespoon honey</span>
  <span class="linenos">17 </span><span class="go">1 tablespoon vegetable oil</span>
  <span class="linenos">18 </span><span class="go">1 clove garlic, minced</span>
  <span class="linenos">19 </span><span class="go">1 teaspoon rice vinegar</span>
  <span class="linenos">20 </span>
  <span class="linenos">21 </span><span class="go">Directions:</span>
  <span class="linenos">22 </span>
  <span class="linenos">23 </span><span class="go">1. In a large bowl, whisk together soy sauce, honey, vege\</span>
  <span class="linenos">24 </span><span class="go">table oil, garlic, and rice vinegar.</span>
  <span class="linenos">25 </span><span class="go">2. Cut the broccoli into small florets. Add the broccoli \</span>
  <span class="linenos">26 </span><span class="go">and chicken to the bowl and toss to coat.</span>
  <span class="linenos">27 </span><span class="go">3. Preheat a grill or grill pan over medium-high heat.</span>
  <span class="linenos">28 </span><span class="go">4. Grill the chicken and broccoli for 5-7 minutes per sid\</span>
  <span class="linenos">29 </span><span class="go">e, or until the chicken is cooked through and the broccol</span>
  <span class="linenos">30 </span><span class="go">i is slightly charred.</span>
  <span class="linenos">31 </span><span class="go">5. Serve immediately.</span>
  </pre></div>
  </figure>
  <p>If you examine the text recipe files I indexed you see that the prediction model merged information from multiple training data recipes while creating new original text for directions that is loosely based on the directions that I wrote and information encoded in the OpenAI text-davinci-002 model.</p>
  <p>Here is the output for the second request:</p>
  <figure class="code"><div class="highlight"><pre><span></span><span class="linenos"> 1 </span><span class="go">Recipe creation request: Create a recipe using Beans, Ric\</span>
  <span class="linenos"> 2 </span><span class="go">e, and Chicken</span>
  <span class="linenos"> 3 </span>
  <span class="linenos"> 4 </span><span class="go">Recipe name: Beans and Rice with Chicken</span>
  <span class="linenos"> 5 </span><span class="go">Number of servings: 4</span>
  <span class="linenos"> 6 </span><span class="go">Ingredients:</span>
  <span class="linenos"> 7 </span><span class="go">1 cup white rice</span>
  <span class="linenos"> 8 </span><span class="go">1 cup black beans</span>
  <span class="linenos"> 9 </span><span class="go">1 chicken breast, cooked and shredded</span>
  <span class="linenos">10 </span><span class="go">1/2 teaspoon cumin</span>
  <span class="linenos">11 </span><span class="go">1/2 teaspoon chili powder</span>
  <span class="linenos">12 </span><span class="go">1/4 teaspoon salt</span>
  <span class="linenos">13 </span><span class="go">1/4 teaspoon black pepper</span>
  <span class="linenos">14 </span><span class="go">1 tablespoon olive oil</span>
  <span class="linenos">15 </span><span class="go">1/2 cup salsa</span>
  <span class="linenos">16 </span><span class="go">1/4 cup cilantro, chopped</span>
  <span class="linenos">17 </span>
  <span class="linenos">18 </span><span class="go">Directions:</span>
  <span class="linenos">19 </span><span class="go">1. Cook rice according to package instructions.</span>
  <span class="linenos">20 </span><span class="go">2. In a medium bowl, combine black beans, chicken, cumin,\</span>
  <span class="linenos">21 </span><span class="go"> chili powder, salt, and black pepper.</span>
  <span class="linenos">22 </span><span class="go">3. Heat olive oil in a large skillet over medium heat. Ad\</span>
  <span class="linenos">23 </span><span class="go">d the bean mixture and cook until heated through, about 5</span>
  <span class="linenos">24 </span><span class="go"> minutes.</span>
  <span class="linenos">25 </span><span class="go">4. Stir in salsa and cilantro. Serve over cooked rice.</span>
  </pre></div>
  </figure>
  <h2 id="cooking-recipe-generation-wrap-up">Cooking Recipe Generation Wrap Up</h2>
  <p>Cooking is one of my favorite activities (in addition to hiking, kayaking, and playing a variety of musical instruments). I originally wrote the <a href="http://cookingspace.com">CookingSpace.com</a> web app to scratch a personal itch: due to a medical issue I had to closely monitor and regulate my vitamin K intake. I used the US Government’s USDA Nutrition Database to estimate the amounts of vitamins and nutrients in some recipes that I use.</p>
  <p>When I wanted to experiment with generative models, backed by my personal recipe data, to create recipes, having available recipe data from my previous project as well as tools like OpenAI APIs and LangChain made this experiment simple to set up and run. It is a common theme in this book that it is now relatively easy to create personal projects based on our data and our interests.</p>
  <h1 id="book-wrap-up">Book Wrap Up</h1>
  <p>This book has been fun to write but it has also somewhat frustrating.</p>
  <p>It was fun because I have never been as excited by new technology as I have by LLMs and utility software like LangChain and LlamaIndex for building personalized applications.</p>
  <p>This book was frustrating in the sense that it is now so very easy to build applications that just a few years would have been impossible to write. Usually when I write books I have two criteria: I only write about things that I am personally interested in and use, and I also hope to figure out non-obvious edge cases and make easier for my readers to use new tech. Here my frustration is writing about something that it is increasingly simple to do so I feel like my value is diminished.</p>
  <p>All that said I hope, dear reader, that you found this book to be worth your time reading.</p>
  <p>What am I going to do next? Although I am not fond of programming in JavaScript (although I find Typescript to be somewhat better), I want to explore the possibilities of writing an open source Persistent Storage Web App Personal Knowledge Base Management System. I might get pushback on this but I would probably make it Apple Safari specific so I can use Apple’s CloudKit JS to make its use seamless across macOS, iPadOS, and iOS. If I get the right kind of feedback on social media I might write a book around this project.</p>
  <p>Thank you for reading my book!</p>
  <p>Best regards,
  Mark Watson</p>
  
  </div>
  